version: '3.8'

services:
  # Main API service
  astro-planner:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: astro-planner
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "9247:9247"
    environment:
      - DATABASE_URL=postgresql://pg:buffalo-jump@host.docker.internal:5432/astro-planner
      - TEST_DATABASE_URL=postgresql://pg:buffalo-jump@host.docker.internal:5432/test_astro_planner
      - HOST=0.0.0.0
      - PORT=9247
      - RELOAD=False
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY:-}
      - DEFAULT_LAT=${DEFAULT_LAT:-45.9183}
      - DEFAULT_LON=${DEFAULT_LON:--111.5433}
      - DEFAULT_ELEVATION=${DEFAULT_ELEVATION:-1234}
      - REDIS_URL=redis://:buffalo-jump@host.docker.internal:6379/1
    networks:
      - astro-planner-network
      - my-redis-network



  # Celery worker for background processing
  celery-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=4
    environment:
      - REDIS_URL=redis://:buffalo-jump@host.docker.internal:6379/1
      - DATABASE_URL=postgresql://pg:buffalo-jump@host.docker.internal:5432/astro-planner
      - FITS_DIR=${FITS_DIR:-/fits}
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ./data:/app/data
      - ./fits:/fits:rw
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "celery -A app.tasks.celery_app inspect ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - astro-planner-network
      - my-redis-network

  # Celery Flower for monitoring (optional)
  flower:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: astro-planner-flower
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: celery -A app.tasks.celery_app flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - REDIS_URL=redis://:buffalo-jump@host.docker.internal:6379/1
    restart: unless-stopped
    networks:
      - astro-planner-network
      - my-redis-network
    profiles:
      - monitoring

networks:
  astro-planner-network:
    driver: bridge
  my-redis-network:
    external: true


