<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Planner - Astrophotography Session Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
            background-color: white;
            color: #333;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
            background-color: white;
            color: #333;
        }

        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        .checkbox-item label {
            cursor: pointer;
        }

        /* Special class for checkboxes with hints below */
        .checkbox-with-hint {
            display: flex;
            flex-direction: column;
        }

        .checkbox-with-hint input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .checkbox-with-hint label {
            cursor: pointer;
        }

        .input-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
            margin-left: 26px;
            line-height: 1.4;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .session-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .summary-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }

        .target-list {
            margin-top: 20px;
        }

        .target-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .target-card:hover {
            border-color: #667eea;
        }

        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .target-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .target-score {
            font-size: 0.85em;
            font-weight: normal;
            color: #666;
        }

        .target-type {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        .target-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .detail-item {
            font-size: 0.95em;
        }

        .detail-item strong {
            color: #555;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .export-btn:hover {
            background: #218838;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none;
        }

        .error.active {
            display: block;
        }

        .weather-forecast {
            background: #e3f2fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .weather-warning {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            display: none;
        }

        .weather-warning.active {
            display: block;
        }

        .weather-warning h3 {
            color: #721c24;
            margin-bottom: 10px;
        }

        .weather-warning p {
            color: #721c24;
            margin-bottom: 15px;
        }

        .weather-warning .btn {
            background: #dc3545;
            padding: 10px 20px;
            font-size: 1em;
        }

        .weather-warning .btn:hover {
            background: #c82333;
        }

        .date-notice {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.95em;
        }

        .pre-plan-forecast {
            border-radius: 8px;
            padding: 12px 15px;
            margin-top: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
        }

        .pre-plan-forecast .forecast-loading {
            color: #94a3b8;
            font-size: 0.9em;
            text-align: center;
        }

        .pre-plan-forecast .forecast-summary {
            font-size: 0.95em;
            line-height: 1.5;
        }

        .pre-plan-forecast .forecast-action {
            margin-top: 10px;
        }

        .pre-plan-forecast .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 8px;
        }

        .pre-plan-forecast.excellent {
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
        }

        .pre-plan-forecast.good {
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        .pre-plan-forecast.fair {
            border-color: #f97316;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.2);
        }

        .pre-plan-forecast.poor {
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .plan-success-banner {
            border-radius: 12px;
            padding: 20px 25px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }

        .plan-success-banner.active {
            display: block;
        }

        .plan-success-banner.excellent {
            background: rgba(16, 185, 129, 0.15);
            border: 2px solid #10b981;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .plan-success-banner.good {
            background: rgba(0, 217, 255, 0.15);
            border: 2px solid #00d9ff;
            box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
        }

        .plan-success-banner.fair {
            background: rgba(249, 115, 22, 0.15);
            border: 2px solid #f97316;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.3);
        }

        .plan-success-banner.poor {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .plan-success-banner h2 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .plan-success-banner.excellent h2 { color: #10b981; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .plan-success-banner.good h2 { color: #00d9ff; text-shadow: 0 0 10px rgba(0, 217, 255, 0.5); }
        .plan-success-banner.fair h2 { color: #f97316; text-shadow: 0 0 10px rgba(249, 115, 22, 0.5); }
        .plan-success-banner.poor h2 { color: #ef4444; text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }

        .plan-success-banner .success-score {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .plan-success-banner.excellent .success-score { color: #10b981; text-shadow: 0 0 15px rgba(16, 185, 129, 0.6); }
        .plan-success-banner.good .success-score { color: #00d9ff; text-shadow: 0 0 15px rgba(0, 217, 255, 0.6); }
        .plan-success-banner.fair .success-score { color: #f97316; text-shadow: 0 0 15px rgba(249, 115, 22, 0.6); }
        .plan-success-banner.poor .success-score { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }

        .plan-success-banner .success-details {
            font-size: 0.95em;
            margin-top: 10px;
            color: #cbd5e1;
        }

        .collapsible-section {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .collapsible-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            user-select: none;
        }

        .collapsible-header:hover {
            background: #e9ecef;
        }

        .collapsible-header h3 {
            margin: 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .collapsible-toggle {
            font-size: 1.5em;
            color: #667eea;
            transition: transform 0.3s;
        }

        .collapsible-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            padding: 20px;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .subsection-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .subsection {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .subsection h4 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .preferences-section {
            margin-bottom: 30px;
        }

        /* QR Code Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s ease;
            color: #333;
        }

        .modal-content label {
            color: #333;
            font-weight: 600;
        }

        .modal-content p {
            color: #666;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.5em;
            margin: 0;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: #333;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #qr-code {
            padding: 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }

        .qr-instructions {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            width: 100%;
        }

        .qr-instructions h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .qr-instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .qr-instructions li {
            margin-bottom: 8px;
        }

        /* Tab Navigation */
        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 25px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Settings subtabs - dark theme compatible */
        .settings-subtab {
            background: rgba(0, 100, 100, 0.3);
            color: #ccc;
            border: 1px solid #00ffff;
            padding: 8px 16px;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.2s;
        }

        .settings-subtab:hover {
            background: rgba(0, 150, 150, 0.4);
        }

        .settings-subtab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .settings-subtab-content {
            display: none;
        }

        .settings-subtab-content.active {
            display: block;
        }

        .settings-card {
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00ffff;
            border-radius: 8px;
            padding: 15px 20px;
        }

        .settings-card h4 {
            margin: 0 0 10px 0;
            color: #00ffff;
        }

        .settings-card .card-details {
            color: #ccc;
            font-size: 0.9em;
        }

        .settings-card .card-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .settings-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .settings-input-row label {
            min-width: 200px;
            font-weight: normal;
            color: #ccc;
        }

        .settings-input-row input {
            flex: 1;
            max-width: 300px;
            background: rgba(0, 20, 40, 0.8);
            border: 1px solid #00ffff;
            color: #fff;
            border-radius: 4px;
        }

        .settings-input-row .setting-description {
            color: #888;
            font-size: 0.85em;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        /* Catalog Browser Styles */
        .catalog-header {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .catalog-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .catalog-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
        }

        .search-box button {
            position: absolute;
            right: 5px;
            top: 5px;
            background: #667eea;
            color: white;
            border: none;
            padding: 7px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .catalog-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .catalog-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .catalog-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .catalog-item-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }

        .catalog-item-type {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .catalog-item-details {
            font-size: 0.9em;
            color: #666;
            line-height: 1.6;
        }

        .catalog-item-details div {
            margin: 5px 0;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pagination button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #5568d3;
        }

        .pagination button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .pagination span {
            font-weight: 600;
            color: #333;
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .filter-tag {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            padding: 0;
        }

        select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            background: white;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        /* Telescope Control Styles */
        .telescope-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .telescope-section h2 {
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            margin-bottom: 20px;
        }

        .telescope-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .telescope-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .telescope-panel h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .connection-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .connection-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        .status-connected {
            background: #2ecc71;
        }

        .status-working {
            background: #f39c12;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .telescope-btn {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .telescope-btn:hover:not(:disabled) {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .telescope-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .telescope-btn.primary {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .telescope-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .progress-panel {
            margin-top: 15px;
        }

        .progress-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .progress-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 6px;
        }

        .progress-item label {
            display: block;
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .progress-item value {
            display: block;
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-bar-container {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            font-weight: 600;
        }

        .error-list {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .error-item {
            font-size: 0.9em;
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        /* Plan Selection Styles */
        .plan-selection-container {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .plan-selection-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .plan-selection-subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .plan-option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }

        .plan-option-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
        }

        .plan-option-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .plan-option-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .plan-option-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .plan-option-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .plan-option-description {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }

        .plan-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .plan-info-banner {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .plan-info-banner strong {
            color: #667eea;
        }

        /* Load Plan Modal Styles */
        .saved-plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .saved-plan-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .saved-plan-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .saved-plan-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .saved-plan-date {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 10px;
        }

        .saved-plan-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .saved-plan-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85em;
        }

        .saved-plan-location {
            color: #667eea;
            font-weight: 600;
        }

        .saved-plan-targets {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .saved-plan-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .saved-plan-delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .saved-plan-delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .saved-plan-load-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            flex: 2;
        }

        .saved-plan-load-btn:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #667eea;
            background: white;
        }

        .loading-spinner::before {
            content: "‚è≥";
            font-size: 3em;
            display: block;
            margin-bottom: 15px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .empty-plans-state {
            text-align: center;
            padding: 60px 20px;
            color: #333;
            background: white;
        }

        .empty-plans-state::before {
            content: "üìã";
            font-size: 4em;
            display: block;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        /* Custom Plan Builder Styles */
        .plan-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.9em;
            color: #333;
        }

        .plan-chip button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-weight: bold;
        }

        .plan-chip button:hover {
            color: #c82333;
        }

        /* Visibility Badge Styles - Task 7 */
        .visibility-badge {
            display: inline-block;
            white-space: nowrap;
        }

        .visibility-info {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
        }
    </style>
    <!-- Tron Theme CSS - loaded AFTER inline styles to ensure proper override -->
    <link rel="stylesheet" href="tron-theme.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        // Define showTab early so onclick handlers work
        let catalogStats = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            const targetTab = document.getElementById(tabName + '-tab');
            const targetBtn = document.getElementById(tabName + '-tab-btn');

            if (targetTab) targetTab.classList.add('active');
            if (targetBtn) targetBtn.classList.add('active');

            // Load catalog stats when switching to catalog tab
            if (tabName === 'catalog' && typeof loadCatalogStats === 'function') {
                loadCatalogStats();
                loadCatalogObjects();
            }

            // Update plan selection UI when switching to observe tab
            if (tabName === 'observe' && typeof updatePlanSelectionUI === 'function') {
                updatePlanSelectionUI();
            }

            // Load settings data when switching to settings tab
            if (tabName === 'settings' && typeof loadSettingsData === 'function') {
                loadSettingsData();
            }

            // Start live view polling when switching to liveview tab
            if (tabName === 'liveview' && typeof liveviewLoadPreview === 'function') {
                liveviewLoadPreview(); // Load immediately
                if (liveviewAutoRefresh && typeof liveviewStartPolling === 'function') {
                    liveviewStartPolling();
                }
            } else if (typeof liveviewStopPolling === 'function') {
                // Stop polling when leaving liveview tab
                liveviewStopPolling();
            }

            // Check weather when switching to planner tab
            if (tabName === 'planner' && typeof checkPrePlanWeather === 'function') {
                checkPrePlanWeather();
            }

            // Initialize process tab when switching to it
            if (tabName === 'process') {
                if (typeof procBrowseFITS === 'function') procBrowseFITS('');
                if (typeof procLoadRecentJobs === 'function') procLoadRecentJobs();
                if (typeof procScanNewObjects === 'function') procScanNewObjects();
                if (typeof procLoadOutputFiles === 'function') procLoadOutputFiles();
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî≠ Astro Planner</h1>
            <p>Astrophotography Session Planner</p>
            <div style="margin-top: 15px;">
                <button class="nav-btn active" onclick="showTab('catalog')" id="catalog-tab-btn">üìö Browse Catalog</button>
                <button class="nav-btn" onclick="showTab('planner')" id="planner-tab-btn">üìÖ Plan</button>
                <button class="nav-btn" onclick="showTab('observe')" id="observe-tab-btn">üî≠ Observe</button>
                <button class="nav-btn" onclick="showTab('process')" id="process-tab-btn">üé® Process</button>
                <button class="nav-btn" onclick="showTab('settings')" id="settings-tab-btn">Settings</button>
            </div>
        </header>

        <div class="content">
            <!-- Planner Tab -->
            <div id="planner-tab" class="tab-content">
            <!-- Location & Device (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible('location-device')">
                    <h3>üìç Location & Device</h3>
                    <span class="collapsible-toggle collapsed" id="location-device-toggle">‚ñº</span>
                </div>
                <div class="collapsible-content collapsed" id="location-device-content">
                    <div class="subsection-container">
                        <!-- Location Subsection -->
                        <div class="subsection">
                            <h4>üìç Location</h4>
                            <div class="form-group">
                                <label for="location-name">Location Name</label>
                                <input type="text" id="location-name" value="Three Forks, MT">
                            </div>
                            <div class="form-group">
                                <label for="latitude">Latitude (degrees)</label>
                                <input type="number" id="latitude" value="45.9183" step="0.0001">
                            </div>
                            <div class="form-group">
                                <label for="longitude">Longitude (degrees)</label>
                                <input type="number" id="longitude" value="-111.5433" step="0.0001">
                            </div>
                            <div class="form-group">
                                <label for="elevation">Elevation (feet)</label>
                                <input type="number" id="elevation" value="4049" step="1">
                            </div>
                            <div class="form-group">
                                <label for="timezone">Timezone</label>
                                <input type="text" id="timezone" value="America/Denver">
                            </div>
                        </div>

                        <!-- Device Subsection -->
                        <div class="subsection">
                            <h4>üî≠ Device</h4>
                            <div class="form-group">
                                <label>Telescope/Equipment</label>
                                <div style="margin-top: 10px;">
                                    <select id="telescope" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;" onchange="updateTelescopeOptions()">
                                        <option value="seestar_s50">Seestar S50 (50mm f/5, 1.27¬∞ √ó 0.71¬∞ FOV)</option>
                                        <option value="other">Other Telescope/Equipment</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group seestar-option" id="exposure-time-group" style="margin-top: 15px;">
                                <label>Exposure Time (Seestar S50)</label>
                                <div style="margin-top: 10px;">
                                    <select id="exposure-time" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                        <option value="10" selected>10 seconds</option>
                                        <option value="20">20 seconds</option>
                                        <option value="30">30 seconds</option>
                                        <option value="60">60 seconds</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preferences Section (Collapsible) -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleCollapsible('preferences')">
                    <h3>üéØ Observing Preferences</h3>
                    <span class="collapsible-toggle" id="preferences-toggle">‚ñº</span>
                </div>
                <div class="collapsible-content" id="preferences-content">
                    <div class="form-group">
                        <label for="observing-date">Observing Date (Tonight's Session)</label>
                        <input type="date" id="observing-date">
                        <!-- Pre-plan forecast box -->
                        <div class="pre-plan-forecast" id="pre-plan-forecast">
                            <div class="forecast-loading" id="forecast-loading">Checking conditions...</div>
                            <div class="forecast-content" id="forecast-content" style="display: none;">
                                <div class="forecast-summary" id="forecast-summary"></div>
                                <div class="forecast-action" id="forecast-action"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="setup-time">Setup Time (minutes)</label>
                            <input type="number" id="setup-time" value="30" min="0" step="5">
                        </div>
                        <div class="form-group">
                            <label for="min-altitude">Minimum Altitude (degrees)</label>
                            <input type="number" id="min-altitude" value="30" min="0" max="90">
                        </div>
                        <div class="form-group">
                            <label for="max-altitude">Maximum Altitude (degrees)</label>
                            <input type="number" id="max-altitude" value="90" min="0" max="90">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Planning Mode</label>
                        <div style="margin-top: 10px;">
                            <select id="planning-mode" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                <option value="balanced">Balanced - Good mix of quality and variety</option>
                                <option value="quality">Best Quality - Longer exposures, fewer targets</option>
                                <option value="quantity">More Objects - Shorter exposures, more targets</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Object Types to Include</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-galaxy" value="galaxy" checked>
                                <label for="type-galaxy">Galaxies</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-nebula" value="nebula" checked>
                                <label for="type-nebula">Nebulae</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-cluster" value="cluster">
                                <label for="type-cluster">Star Clusters</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-planetary" value="planetary_nebula" checked>
                                <label for="type-planetary">Planetary Nebulae</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-comet" value="comet">
                                <label for="type-comet">Comets</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="type-asteroid" value="asteroid">
                                <label for="type-asteroid">Asteroids</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-with-hint">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="daytime-planning" value="daytime" style="margin: 0;">
                                <label for="daytime-planning" style="margin: 0;">Daytime Planning Mode</label>
                            </div>
                            <div class="input-hint">
                                Plan from sunrise to sunset for solar/lunar observations. Note: Solar observing requires proper solar filter.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-with-hint">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="park-when-done" value="park" style="margin: 0;">
                                <label for="park-when-done" style="margin: 0;">Park telescope when done</label>
                            </div>
                            <div class="input-hint">
                                Closes the telescope cover after completing all targets. Uncheck if using a filter tube or dew shield.
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn" onclick="generatePlan()">Generate Observing Plan</button>
                    </div>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Calculating optimal observing plan...</p>
            </div>

            <!-- Error Message -->
            <div class="error" id="error"></div>

            <!-- Results -->
            <div class="results" id="results">
                <!-- Plan Success Banner -->
                <div class="plan-success-banner" id="plan-success-banner">
                    <h2 id="success-banner-title"></h2>
                    <div class="success-score" id="success-banner-score"></div>
                    <div class="success-details" id="success-banner-details"></div>
                </div>

                <!-- Weather Warning -->
                <div class="weather-warning" id="weather-warning">
                    <h3>‚ö†Ô∏è Poor Observing Conditions</h3>
                    <p id="weather-warning-text"></p>
                    <button class="btn" onclick="tryNextNight()">Try Next Night ‚Üí</button>
                </div>

                <div class="section">
                    <h2>Observation Plan</h2>
                    <div class="session-summary" id="session-summary"></div>
                </div>

                <div class="section">
                    <h2>Scheduled Targets</h2>
                    <div class="target-list" id="target-list"></div>
                </div>

                <div class="section">
                    <h2>Export Plan</h2>
                    <div class="export-buttons">
                        <button class="export-btn" onclick="showSavePlanModal()">üíæ Save This Plan</button>
                        <button class="export-btn" onclick="showQRCode()">üì± Share QR Code</button>
                        <button class="export-btn" onclick="exportPlan('json')">üìÑ Export JSON</button>
                        <button class="export-btn seestar-export" id="export-seestar-plan" onclick="exportPlan('seestar_plan')">üî≠ Seestar Plan Mode</button>
                        <button class="export-btn seestar-export" id="export-seestar-alp" onclick="exportPlan('seestar_alp')">üöÄ seestar_alp CSV (Recommended)</button>
                        <button class="export-btn" onclick="exportPlan('text')">üìù Text Format</button>
                        <button class="export-btn" onclick="exportPlan('csv')">üìä CSV Format</button>
                    </div>

                    <div class="date-notice seestar-export" id="seestar-help" style="margin-top: 15px; display: none;">
                        <strong>Using Your Plan:</strong><br><br>

                        <strong>Direct Control (Recommended)</strong><br>
                        Go to the <strong>Observe</strong> tab, connect to your Seestar, and click Execute Plan. No external software needed.<br><br>

                        <strong>Export for seestar_alp</strong><br>
                        Click "seestar_alp CSV" above to download. Import the CSV file into <a href="https://github.com/smart-underworld/seestar_alp" target="_blank" style="color: #667eea;">seestar_alp</a> for automated sequencing.
                    </div>
                </div>
            </div>
            </div>
            <!-- End Planner Tab -->

            <!-- Catalog Browser Tab -->
            <div id="catalog-tab" class="tab-content active">
                <!-- Catalog Stats Header -->
                <div class="catalog-header">
                    <h2>üìö Deep Sky Object Catalog</h2>
                    <p>Browse 12,394 deep sky objects from OpenNGC catalog (Messier, NGC, and IC objects)</p>
                    <div class="catalog-stats" id="catalog-stats-grid">
                        <div class="stat-card">
                            <span class="stat-value">-</span>
                            <span class="stat-label">Total Objects</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">-</span>
                            <span class="stat-label">Galaxies</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">-</span>
                            <span class="stat-label">Clusters</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">-</span>
                            <span class="stat-label">Nebulae</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-value">-</span>
                            <span class="stat-label">Planetary Nebulae</span>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="catalog-filters">
                    <h3>üîç Search & Filter</h3>

                    <div class="search-box">
                        <input type="text" id="catalog-search" placeholder="Search by name or catalog ID (e.g., M31, NGC7000, Andromeda)">
                        <button onclick="searchCatalog()">Search</button>
                    </div>

                    <div class="filter-row">
                        <div class="form-group">
                            <label for="filter-object-type">Object Type</label>
                            <select id="filter-object-type" onchange="applyCatalogFilters()">
                                <option value="">All Types</option>
                                <option value="galaxy">Galaxies</option>
                                <option value="cluster">Star Clusters</option>
                                <option value="nebula">Nebulae</option>
                                <option value="planetary_nebula">Planetary Nebulae</option>
                                <option value="comet">Comets</option>
                                <option value="asteroid">Asteroids</option>
                                <option value="planet">Planets</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="filter-min-magnitude">Min Brightness (mag)</label>
                            <input type="number" id="filter-min-magnitude" placeholder="e.g., 0" step="0.1" onchange="applyCatalogFilters()">
                        </div>

                        <div class="form-group">
                            <label for="filter-max-magnitude">Max Brightness (mag)</label>
                            <input type="number" id="filter-max-magnitude" placeholder="e.g., 12" step="0.1" onchange="applyCatalogFilters()">
                        </div>

                        <div class="form-group">
                            <label for="filter-constellation">Constellation</label>
                            <input type="text" id="filter-constellation" placeholder="e.g., Ori, And" maxlength="3" onchange="applyCatalogFilters()">
                        </div>
                    </div>

                    <div class="filter-tags" id="active-filters"></div>

                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn" style="padding: 10px 20px; font-size: 0.9em;" onclick="clearCatalogFilters()">Clear Filters</button>
                    </div>
                </div>

                <!-- Custom Plan Builder -->
                <div id="custom-plan-container" style="display: none; background: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; color: #333;">üéØ Your Custom Plan (<span id="plan-count">0</span> objects)</h3>

                    <div id="plan-chips" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <!-- Chips rendered by JavaScript -->
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="customPlan.generatePlan()" class="btn" style="background: #667eea; color: white; padding: 12px 24px; flex: 1;">
                            Generate Optimized Plan
                        </button>
                        <button onclick="customPlan.clear()" class="btn" style="background: #dc3545; color: white; padding: 12px 24px;">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator for Catalog -->
                <div class="loading" id="catalog-loading">
                    <div class="spinner"></div>
                    <p>Loading catalog...</p>
                </div>

                <!-- Catalog Results -->
                <div id="catalog-results">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="catalog-results-count">Showing 0 objects</h3>
                        <div style="font-size: 0.9em; color: #666;">
                            Lower magnitude = brighter objects
                        </div>
                    </div>

                    <div class="catalog-grid" id="catalog-grid"></div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <button id="prev-page" onclick="previousPage()" disabled>‚Üê Previous</button>
                        <span id="page-info">Page 1</span>
                        <button id="next-page" onclick="nextPage()">Next ‚Üí</button>
                    </div>
                </div>
            </div>
            <!-- End Catalog Browser Tab -->

            <!-- Observe Tab -->
            <div id="observe-tab" class="tab-content">
                <div class="section">
                    <h2>üî≠ Observe</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        Real-time observation plan execution monitoring and telescope control
                    </p>
                </div>

                <!-- Plan Selection Section -->
                <div class="plan-selection-container">
                    <div class="plan-selection-title">Choose Your Observation Plan</div>
                    <div class="plan-selection-subtitle">Select how you want to start your observing session</div>

                    <div class="plan-option-grid">
                        <!-- Option 1: Start Live Session -->
                        <div class="plan-option-card" id="plan-option-live" onclick="startLiveSession()">
                            <span class="plan-option-icon">‚ñ∂Ô∏è</span>
                            <div class="plan-option-title">Start Live Session</div>
                            <div class="plan-option-description">
                                Execute the current plan from the Planner tab immediately
                            </div>
                        </div>

                        <!-- Option 2: Load Saved Plan -->
                        <div class="plan-option-card" id="plan-option-load" onclick="showLoadPlanModal()">
                            <span class="plan-option-icon">üìÇ</span>
                            <div class="plan-option-title">Load Saved Plan</div>
                            <div class="plan-option-description">
                                Browse and select from your previously saved observation plans
                            </div>
                        </div>

                        <!-- Option 3: Create New Plan -->
                        <div class="plan-option-card" id="plan-option-create" onclick="goToPlanner()">
                            <span class="plan-option-icon">‚ú®</span>
                            <div class="plan-option-title">Create New Plan</div>
                            <div class="plan-option-description">
                                Navigate to the Planner to design a new observing session
                            </div>
                        </div>
                    </div>

                    <!-- Current Plan Info Banner -->
                    <div class="plan-info-banner" id="current-plan-info" style="display: none;">
                        <strong>Current Plan:</strong> <span id="current-plan-name">-</span>
                        <span style="margin-left: 20px; color: #666;">
                            <strong>Targets:</strong> <span id="current-plan-target-count">0</span>
                        </span>
                        <span style="margin-left: 20px; color: #666;">
                            <strong>Location:</strong> <span id="current-plan-location">-</span>
                        </span>
                    </div>
                </div>

                <!-- Main layout: sidebar + content -->
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                    <!-- Sidebar: Connection & Control -->
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <!-- Connection Panel -->
                        <div class="telescope-panel">
                            <h3 style="font-size: 1em; margin-bottom: 12px;">üîå Connection</h3>
                            <input type="text" id="telescope-host-main" placeholder="IP Address" value="192.168.2.47" style="width: 100%; font-size: 0.9em; padding: 8px; margin-bottom: 8px; box-sizing: border-box;">
                            <button class="telescope-btn" id="connect-btn-main" onclick="connectTelescopeMain()" style="width: 100%; padding: 10px; font-size: 0.95em;">Connect</button>
                            <div style="margin-top: 10px; font-size: 0.9em;">
                                <span class="status-indicator status-disconnected" id="status-indicator-main"></span>
                                <span id="connection-status-main">Disconnected</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em; opacity: 0.8;" id="firmware-version-main"></div>
                        </div>

                        <!-- Execution Control Panel -->
                        <div class="telescope-panel">
                            <h3 style="font-size: 1em; margin-bottom: 12px;">‚ö° Control</h3>
                            <button class="telescope-btn primary" id="execute-btn-main" onclick="executePlanMain()" disabled style="padding: 10px; font-size: 0.95em; margin-top: 8px;">
                                ‚ñ∂Ô∏è Execute Plan
                            </button>
                            <button class="telescope-btn danger" id="abort-btn-main" onclick="abortExecutionMain()" disabled style="padding: 10px; font-size: 0.95em; margin-top: 8px;">
                                ‚èπÔ∏è Abort
                            </button>
                            <button class="telescope-btn" id="park-btn-main" onclick="parkTelescopeMain()" disabled style="padding: 10px; font-size: 0.95em; margin-top: 8px;">
                                üè† Park
                            </button>
                        </div>

                        <!-- Quick Info -->
                        <div class="telescope-panel" style="font-size: 0.85em;">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">‚ÑπÔ∏è Quick Start</h3>
                            <ol style="margin-left: 18px; line-height: 1.6; opacity: 0.9;">
                                <li>Choose a plan option above</li>
                                <li>Connect to telescope</li>
                                <li>Click <strong>Execute Plan</strong></li>
                                <li>Monitor progress below</li>
                            </ol>
                        </div>

                        <!-- Current Conditions Widget -->
                        <div class="telescope-panel" style="font-size: 0.85em;">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üåå Current Conditions</h3>
                            <div id="observe-conditions-content" style="line-height: 1.6;">
                                <div style="text-align: center; padding: 10px; opacity: 0.6;">
                                    Click "Refresh" to load conditions
                                </div>
                            </div>
                            <button class="telescope-btn" onclick="refreshObserveConditions()" style="width: 100%; padding: 8px; font-size: 0.9em; margin-top: 10px;">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Main Content: Status & Progress -->
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Large Execution Status Banner -->
                        <div id="execution-status-banner" style="display: none; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div style="font-size: 3em; animation: pulse 2s ease-in-out infinite;">üî≠</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 1.8em; font-weight: bold; color: white; margin-bottom: 8px;">
                                        <span id="execution-state-text">EXECUTING PLAN</span>
                                    </div>
                                    <div style="font-size: 1.1em; color: rgba(255,255,255,0.95); margin-bottom: 4px;" id="execution-status-detail">
                                        Preparing telescope...
                                    </div>
                                    <div style="font-size: 0.95em; color: rgba(255,255,255,0.8);" id="execution-targets-summary">
                                        Target <span id="execution-target-number">1</span> of <span id="execution-total-targets">5</span>
                                    </div>
                                </div>
                                <div style="text-align: right; color: white;">
                                    <div style="font-size: 3em; font-weight: bold; line-height: 1;" id="execution-progress-number">0%</div>
                                    <div style="font-size: 1em; opacity: 0.9; margin-top: 8px;" id="execution-time-display">00:00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Progress Panel -->
                        <div class="telescope-panel progress-panel" id="progress-panel-main" style="display: none;">
                            <h3 style="margin-bottom: 15px;">üìä Execution Progress</h3>

                            <div class="progress-info">
                                <div class="progress-item">
                                    <label>Current Target</label>
                                    <value id="current-target-main">-</value>
                                </div>
                                <div class="progress-item">
                                    <label>Phase</label>
                                    <value id="current-phase-main">-</value>
                                </div>
                                <div class="progress-item">
                                    <label>Completed</label>
                                    <value id="targets-completed-main">0 / 0</value>
                                </div>
                                <div class="progress-item">
                                    <label>Elapsed Time</label>
                                    <value id="elapsed-time-main">-</value>
                                </div>
                                <div class="progress-item">
                                    <label>Estimated Remaining</label>
                                    <value id="estimated-remaining-main">-</value>
                                </div>
                            </div>

                            <div class="progress-bar-container">
                                <div class="progress-bar" id="progress-bar-main" style="width: 0%">0%</div>
                            </div>

                            <div id="error-panel-main" style="display: none;">
                                <h4 style="margin-top: 15px; margin-bottom: 10px;">‚ö†Ô∏è Errors</h4>
                                <div class="error-list" id="error-list-main"></div>
                            </div>
                        </div>

                        <!-- Collapsible Live View -->
                        <div class="telescope-panel">
                            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleLiveViewEmbed()">
                                <h3 style="margin: 0;">üìπ Telescope Live View</h3>
                                <span id="liveview-toggle-icon" style="font-size: 1.2em; transition: transform 0.3s;">‚ñº</span>
                            </div>
                            <div id="liveview-embed-container" style="display: none; margin-top: 15px;">
                                <p style="text-align: center; color: #888; margin-bottom: 15px;">
                                    Click below to open the full telescope camera feed in a dedicated tab
                                </p>
                                <button onclick="showTab('liveview'); event.stopPropagation();" class="telescope-btn" style="width: 100%; padding: 12px; font-size: 0.95em;">
                                    üìπ Open Live View Tab ‚Üí
                                </button>
                            </div>
                        </div>

                        <!-- Idle Status Info (shown when not executing) -->
                        <div class="telescope-panel" id="status-info-panel">
                            <h3>‚ÑπÔ∏è Ready to Observe</h3>
                            <div style="background: rgba(0,0,0,0.1); padding: 20px; border-radius: 6px;">
                                <p style="margin-bottom: 15px; font-size: 1.05em;">
                                    <strong>No execution in progress</strong>
                                </p>
                                <p style="line-height: 1.6; opacity: 0.9;">
                                    Connect your telescope using the panel on the left, then click <strong>Execute Plan</strong> to begin automated imaging.
                                    The real-time status will appear here during execution.
                                </p>
                                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.8; padding: 10px; background: rgba(102, 126, 234, 0.1); border-left: 3px solid #667eea; border-radius: 4px;">
                                    üí° <strong>Tip:</strong> Generate an observation plan in the Planner tab first. The Live View tab shows your telescope's camera feed in real-time.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Observe Tab -->

            <!-- Process Tab -->
            <div id="process-tab" class="tab-content">
                <!-- File Browser Section -->
                <div style="margin: 30px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">Browse FITS Files</h2>
                        <button id="proc-newObjectsBtn" class="btn btn-primary" onclick="procProcessNewObjects()" style="display: none;">
                            üì∏ Process <span id="proc-newObjectsCount">0</span> Objects
                        </button>
                    </div>
                    <div id="proc-fileBrowser" style="background: rgba(0,20,40,0.8); border: 1px solid #00ffff; border-radius: 8px; padding: 20px; margin-top: 15px;">
                        <div id="proc-currentPath" style="margin-bottom: 10px; color: #888; font-size: 0.9em;"></div>
                        <div id="proc-fileList" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>
                </div>

                <!-- Selected File Section -->
                <div id="proc-selectedFileSection" style="display: none; margin: 30px 0;">
                    <h2>Selected File</h2>
                    <div style="background: rgba(0,100,100,0.2); border: 1px solid #00ffff; border-radius: 8px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 1.2em; color: #00ffff;">üìÑ <span id="proc-selectedFileName"></span></div>
                                <div style="color: #888; margin-top: 5px;"><span id="proc-selectedFilePath"></span></div>
                            </div>
                            <button onclick="procClearSelection()" class="btn btn-secondary">Clear</button>
                        </div>
                    </div>

                    <!-- Processing Options -->
                    <div style="margin: 20px 0;">
                        <h3>Processing Options</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="procProcessFile('quick_preview')" class="btn btn-primary">
                                ‚ö° Quick Preview (Auto-Stretch JPEG)
                            </button>
                            <button onclick="procProcessFile('export_editing')" class="btn btn-secondary">
                                üì§ Export for Editing (16-bit TIFF)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Current Job Status -->
                <div id="proc-jobStatus" style="display: none; margin: 30px 0;"></div>

                <!-- Two-Column Layout: Outputs and Recent Jobs -->
                <div style="margin: 30px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Left Column: Output Files -->
                        <div>
                            <h2>Output Files</h2>
                            <div id="proc-outputFiles" style="margin-top: 15px; max-height: 600px; overflow-y: auto;">
                                <p style="color: #888; text-align: center; padding: 40px 20px;">No output files yet</p>
                            </div>
                        </div>

                        <!-- Right Column: Recent Jobs -->
                        <div>
                            <h2>Recent Jobs</h2>
                            <div id="proc-recentJobs" style="margin-top: 15px; max-height: 600px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Process Tab -->

            <!-- Live View Tab -->
            <div id="liveview-tab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h1 style="margin: 0;">üìπ Live Telescope View</h1>
                        <p style="color: #888; margin: 5px 0 0 0;">View the latest image from your telescope in near real-time</p>
                    </div>
                    <button onclick="showTab('observe')" class="btn btn-secondary" style="padding: 10px 20px; white-space: nowrap;">
                        ‚Üê Back to Observe
                    </button>
                </div>

                <!-- Preview Display -->
                <div style="margin: 30px 0;">
                    <div style="background: rgba(0,20,40,0.8); border: 1px solid #00ffff; border-radius: 8px; padding: 20px;">
                        <!-- Status Bar -->
                        <div id="liveview-status" style="margin-bottom: 15px; padding: 10px; background: rgba(0,100,100,0.2); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span id="liveview-status-text" style="color: #00ffff;">Checking for telescope images...</span>
                                </div>
                                <div>
                                    <button onclick="liveviewRefreshNow()" class="btn btn-secondary" style="padding: 5px 15px; font-size: 0.9em;">üîÑ Refresh Now</button>
                                    <button onclick="liveviewToggleAuto()" class="btn btn-primary" id="liveview-auto-btn" style="padding: 5px 15px; font-size: 0.9em;">‚è∏Ô∏è Pause Auto-Refresh</button>
                                </div>
                            </div>
                            <div id="liveview-last-update" style="color: #666; font-size: 0.85em; margin-top: 5px;"></div>
                        </div>

                        <!-- Image Display -->
                        <div id="liveview-image-container" style="text-align: center; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                            <div id="liveview-placeholder" style="color: #888;">
                                <p style="font-size: 1.2em;">No telescope image available yet</p>
                                <p style="font-size: 0.9em; margin-top: 10px;">Start imaging on your telescope to see live updates here</p>
                            </div>
                            <img id="liveview-image" style="display: none; max-width: 100%; max-height: 800px; border-radius: 4px;" />
                        </div>

                        <!-- Image Info -->
                        <div id="liveview-info" style="display: none; margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
                                <div><strong>Filename:</strong> <span id="liveview-filename"></span></div>
                                <div><strong>Size:</strong> <span id="liveview-filesize"></span></div>
                                <div><strong>Last Modified:</strong> <span id="liveview-modified"></span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div style="margin: 30px 0;">
                    <h3>Settings</h3>
                    <div style="background: rgba(0,20,40,0.5); border: 1px solid #00ffff; border-radius: 8px; padding: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Auto-Refresh Interval</label>
                            <select id="liveview-interval" onchange="liveviewChangeInterval()" style="width: 200px; padding: 8px; background: rgba(0,20,40,0.8); border: 1px solid #00ffff; color: #fff; border-radius: 4px;">
                                <option value="10000">Every 10 seconds</option>
                                <option value="30000" selected>Every 30 seconds</option>
                                <option value="60000">Every 1 minute</option>
                                <option value="120000">Every 2 minutes</option>
                                <option value="300000">Every 5 minutes</option>
                            </select>
                        </div>
                        <div style="color: #888; font-size: 0.9em;">
                            <p>üí° Tip: The telescope creates preview JPEG images during stacking. This view automatically polls for the latest image.</p>
                            <p style="margin-top: 5px;">üìÅ Images are loaded from the FITS directory configured in your environment.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Live View Tab -->

            <!-- Astronomy Tab -->

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Settings</h2>

                <!-- Settings Sub-tabs -->
                <div style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
                    <button class="settings-subtab active" onclick="showSettingsSubtab('devices')" id="devices-subtab-btn">Seestar Devices</button>
                    <button class="settings-subtab" onclick="showSettingsSubtab('locations')" id="locations-subtab-btn">Observing Locations</button>
                    <button class="settings-subtab" onclick="showSettingsSubtab('app')" id="app-subtab-btn">Application Settings</button>
                </div>

                <!-- Devices Sub-tab -->
                <div id="devices-subtab" class="settings-subtab-content active">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Seestar Devices</h3>
                        <button class="btn btn-primary" onclick="showDeviceModal()">+ Add Device</button>
                    </div>
                    <div id="devices-list" style="display: grid; gap: 15px;">
                        <!-- Devices loaded dynamically -->
                    </div>
                </div>

                <!-- Locations Sub-tab -->
                <div id="locations-subtab" class="settings-subtab-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Observing Locations</h3>
                        <button class="btn btn-primary" onclick="showLocationModal()">+ Add Location</button>
                    </div>
                    <div id="locations-list" style="display: grid; gap: 15px;">
                        <!-- Locations loaded dynamically -->
                    </div>
                </div>

                <!-- App Settings Sub-tab -->
                <div id="app-subtab" class="settings-subtab-content" style="display: none;">
                    <h3>Application Settings</h3>
                    <p style="color: #666; margin-bottom: 20px;">Configure telescope paths, processing directories, and UI preferences.</p>

                    <div id="telescope-settings-section" style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Telescope Settings</h4>
                        <div id="telescope-settings-list"></div>
                    </div>

                    <div id="processing-settings-section" style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Processing Settings</h4>
                        <div id="processing-settings-list"></div>
                    </div>

                    <div id="storage-settings-section" style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Storage Settings</h4>
                        <div id="storage-settings-list"></div>
                    </div>

                    <div id="ui-settings-section" style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">UI Settings</h4>
                        <div id="ui-settings-list"></div>
                    </div>

                    <div id="planning-settings-section" style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">Daily Planning Settings</h4>
                        <div id="planning-settings-list"></div>
                    </div>

                    <button class="btn btn-primary" onclick="saveAllAppSettings()">Save All Settings</button>
                </div>
            </div>
            <!-- End Settings Tab -->
        </div>
    </div>

    <!-- Device Modal -->
    <div id="device-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="device-modal-title">Add Seestar Device</h2>
                <button class="close-btn" onclick="closeDeviceModal()">&times;</button>
            </div>
            <form id="device-form" onsubmit="saveDevice(event)">
                <input type="hidden" id="device-id">
                <div class="form-group">
                    <label for="device-name">Device Name *</label>
                    <input type="text" id="device-name" required>
                </div>
                <div class="form-group">
                    <label for="device-description">Description</label>
                    <input type="text" id="device-description">
                </div>
                <h4 style="margin: 20px 0 15px; color: #667eea;">Control Settings (API)</h4>
                <div class="form-group">
                    <label for="device-control-host">Control Host (IP Address)</label>
                    <input type="text" id="device-control-host" placeholder="e.g., 192.168.1.100">
                </div>
                <div class="form-group">
                    <label for="device-control-port">Control Port</label>
                    <input type="number" id="device-control-port" value="4700">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="device-control-enabled"> Enable Control</label>
                </div>
                <h4 style="margin: 20px 0 15px; color: #667eea;">Mount Settings (Storage)</h4>
                <div class="form-group">
                    <label for="device-mount-path">Mount Path</label>
                    <input type="text" id="device-mount-path" placeholder="e.g., /mnt/seestar">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="device-mount-enabled"> Enable Mount</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="device-is-default"> Set as Default Device</label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Save Device</button>
                    <button type="button" class="btn" onclick="closeDeviceModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="location-modal-title">Add Observing Location</h2>
                <button class="close-btn" onclick="closeLocationModal()">&times;</button>
            </div>
            <form id="location-form" onsubmit="saveLocation(event)">
                <input type="hidden" id="location-id">
                <div class="form-group">
                    <label for="location-name">Location Name *</label>
                    <input type="text" id="location-name-input" required>
                </div>
                <div class="form-group">
                    <label for="location-description">Description</label>
                    <input type="text" id="location-description">
                </div>
                <div class="form-group">
                    <label for="location-latitude">Latitude *</label>
                    <input type="number" id="location-latitude" step="0.0001" min="-90" max="90" required>
                </div>
                <div class="form-group">
                    <label for="location-longitude">Longitude *</label>
                    <input type="number" id="location-longitude" step="0.0001" min="-180" max="180" required>
                </div>
                <div class="form-group">
                    <label for="location-elevation">Elevation (meters)</label>
                    <input type="number" id="location-elevation" value="0">
                </div>
                <div class="form-group">
                    <label for="location-timezone">Timezone</label>
                    <input type="text" id="location-timezone" value="UTC" placeholder="e.g., America/Denver">
                </div>
                <div class="form-group">
                    <label for="location-bortle">Bortle Class (1-9)</label>
                    <input type="number" id="location-bortle" min="1" max="9">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="location-is-default"> Set as Default Location</label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">Save Location</button>
                    <button type="button" class="btn" onclick="closeLocationModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì± Share Observing Plan</h2>
                <button class="close-btn" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="qr-container">
                <div id="qr-code"></div>
                <div class="qr-instructions">
                    <h3>How to use:</h3>
                    <ol>
                        <li>Scan the QR code with your phone or tablet</li>
                        <li>Opens a shareable web page with your plan</li>
                        <li>Download CSV for seestar_alp import</li>
                        <li>Share the URL with others</li>
                    </ol>
                    <small style="opacity: 0.7; display: block; margin-top: 10px;">
                        üí° The QR code contains a short URL to your plan. Plans are stored temporarily on this server.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Object Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="preview-title">üî≠ Object Preview</h2>
                <button class="close-btn" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="preview-container">
                <!-- Aladin Lite Sky Viewer -->
                <div id="aladin-lite-div" style="width: 100%; height: 400px; background: #0a0e27; border: 2px solid #475569; border-radius: 8px;"></div>

                <div style="margin-top: 20px;">
                    <h3 style="color: #00d9ff; margin-bottom: 15px;">Additional Resources</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <a id="simbad-link" href="#" target="_blank" class="resource-link" style="padding: 10px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; text-decoration: none; color: #00d9ff; text-align: center;">
                            üìö SIMBAD Database
                        </a>
                        <a id="wikisky-link" href="#" target="_blank" class="resource-link" style="padding: 10px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; text-decoration: none; color: #00d9ff; text-align: center;">
                            üåå WikiSky
                        </a>
                        <a id="astrobin-link" href="#" target="_blank" class="resource-link" style="padding: 10px; background: #1e293b; border: 1px solid #475569; border-radius: 6px; text-decoration: none; color: #00d9ff; text-align: center;">
                            üì∏ AstroBin Search
                        </a>
                    </div>
                </div>

                <div class="date-notice" style="margin-top: 20px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444;">
                    <strong>‚ö†Ô∏è Your Mileage May Vary</strong><br>
                    These preview images are professional captures or survey data. Your actual images will vary based on:
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Light pollution</strong> - Bortle scale at your location greatly affects results</li>
                        <li><strong>Equipment</strong> - Different telescopes and cameras capture different detail</li>
                        <li><strong>Exposure time</strong> - Longer exposures reveal more detail</li>
                        <li><strong>Processing</strong> - Post-processing techniques dramatically affect final images</li>
                        <li><strong>Atmospheric conditions</strong> - Seeing, transparency, and weather impact quality</li>
                    </ul>
                    <small style="opacity: 0.8; display: block; margin-top: 10px;">
                        üí° <strong>Tip:</strong> Use previews as a guide for framing and composition, not as expectations for your raw captures!
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Plan Modal -->
    <div id="save-plan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ Save Observation Plan</h2>
                <button class="close-btn" onclick="closeSavePlanModal()">&times;</button>
            </div>
            <div class="save-plan-form">
                <div class="form-group">
                    <label for="plan-name">Plan Name <span style="color: red;">*</span></label>
                    <input type="text" id="plan-name" placeholder="e.g., M31 Andromeda Session" required>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label for="plan-description">Description (Optional)</label>
                    <textarea id="plan-description" placeholder="Add notes about this observation plan..."></textarea>
                </div>
                <div id="save-plan-error" style="color: #dc3545; margin-top: 10px; display: none;"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" style="background: #6c757d; padding: 10px 20px; font-size: 1em;" onclick="closeSavePlanModal()">Cancel</button>
                    <button class="btn" style="padding: 10px 20px; font-size: 1em;" onclick="savePlan()">Save Plan</button>
                </div>
            </div>
            <div id="save-plan-success" style="display: none; text-align: center; padding: 20px; background: white;">
                <div style="font-size: 3em; color: #28a745; margin-bottom: 10px;">‚úì</div>
                <h3 style="color: #28a745; margin-bottom: 10px;">Plan Saved Successfully!</h3>
                <p style="color: #333; margin-bottom: 20px;">Your observation plan has been saved and can be loaded later.</p>
                <button class="btn" style="padding: 10px 20px; font-size: 1em;" onclick="closeSavePlanModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Load Plan Modal -->
    <div id="load-plan-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>üìÇ Load Saved Plan</h2>
                <button class="close-btn" onclick="closeLoadPlanModal()">&times;</button>
            </div>
            <div id="load-plan-content">
                <!-- Loading State -->
                <div id="load-plan-loading" class="loading-spinner">
                    Loading saved plans...
                </div>

                <!-- Empty State -->
                <div id="load-plan-empty" class="empty-plans-state" style="display: none;">
                    <h3>No Saved Plans Yet</h3>
                    <p style="margin-top: 10px;">You haven't saved any observation plans yet.</p>
                    <p style="margin-top: 5px;">Create a plan in the Planner tab and save it to see it here.</p>
                    <button class="btn" style="margin-top: 20px; padding: 10px 20px;" onclick="closeLoadPlanModal(); goToPlanner();">
                        Go to Planner
                    </button>
                </div>

                <!-- Plans Grid -->
                <div id="load-plan-grid" class="saved-plans-grid" style="display: none;">
                    <!-- Plans will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Target Altitude Chart Modal -->
    <div id="altitude-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--tron-border);">
                <h2 id="altitude-modal-title" style="color: var(--tron-cyan); margin: 0;">Target Details</h2>
                <button onclick="closeAltitudeModal()" style="background: none; border: none; color: var(--tron-cyan); font-size: 1.5em; cursor: pointer; padding: 0 10px;">&times;</button>
            </div>

            <!-- Target Metadata -->
            <div id="altitude-modal-metadata" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--tron-panel); border: 1px solid var(--tron-border); border-radius: 8px;">
            </div>

            <!-- Chart Container -->
            <div style="margin-bottom: 20px;">
                <canvas id="altitude-chart" style="max-height: 400px;"></canvas>
            </div>

            <!-- Imaging Window Info -->
            <div id="altitude-modal-info" style="padding: 10px; background: var(--tron-panel); border-left: 3px solid var(--tron-cyan); border-radius: 4px; font-size: 0.9em; opacity: 0.9;">
            </div>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; max-height: 95vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--tron-border);">
                <h2 style="color: var(--tron-cyan); margin: 0;">üî¨ Processing Comparison</h2>
                <button onclick="closeComparisonModal()" style="background: none; border: none; color: var(--tron-cyan); font-size: 1.5em; cursor: pointer; padding: 0 10px;">&times;</button>
            </div>

            <p style="color: #888; margin-bottom: 20px;">Compare your processed output with Seestar's built-in processing</p>

            <!-- Side-by-side images -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div>
                    <h3 style="color: var(--tron-cyan); margin-bottom: 10px;">Your Processing</h3>
                    <img id="comparison-our-image" src="" alt="Our processing" style="width: 100%; max-height: 400px; object-fit: contain; border: 2px solid var(--tron-border); border-radius: 8px;">
                </div>
                <div>
                    <h3 style="color: #ff00ff; margin-bottom: 10px;">Seestar Processing</h3>
                    <img id="comparison-seestar-image" src="" alt="Seestar processing" style="width: 100%; max-height: 400px; object-fit: contain; border: 2px solid #ff00ff; border-radius: 8px;">
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="comparison-analysis" style="margin-top: 30px;">
                <h3 style="color: var(--tron-cyan); margin-bottom: 15px;">üìä Analysis</h3>
                <div id="comparison-analysis-content" style="color: #888;">
                    <p style="text-align: center; padding: 20px;">Loading analysis...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://aladin.cds.unistra.fr/AladinLite/api/v3/latest/aladin.js" charset="utf-8"></script>

    <!-- Chart.js for altitude graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // Set today's date as default (after DOM loads)
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('observing-date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
                // Check weather when date changes
                dateInput.addEventListener('change', function() {
                    if (typeof checkPrePlanWeather === 'function') {
                        checkPrePlanWeather();
                    }
                });
            }

            // Load catalog stats on initial page load since catalog tab is active by default
            if (typeof loadCatalogStats === 'function') {
                loadCatalogStats();
                loadCatalogObjects();
            }
        });

        let currentPlan = null;

        // Update telescope-specific options (exports and exposure time)
        function updateTelescopeOptions() {
            const telescope = document.getElementById('telescope').value;
            const seestarExports = document.querySelectorAll('.seestar-export');
            const seestarOptions = document.querySelectorAll('.seestar-option');

            if (telescope === 'seestar_s50') {
                // Show Seestar-specific exports and help
                seestarExports.forEach(elem => {
                    // Buttons use inline-block, divs use block
                    elem.style.display = elem.tagName === 'BUTTON' ? 'inline-block' : 'block';
                });
                // Show Seestar-specific options (exposure time)
                seestarOptions.forEach(opt => {
                    opt.style.display = 'flex';
                });
            } else {
                // Hide Seestar-specific exports and help
                seestarExports.forEach(elem => {
                    elem.style.display = 'none';
                });
                // Hide Seestar-specific options (exposure time)
                seestarOptions.forEach(opt => {
                    opt.style.display = 'none';
                });
            }
        }

        // Initialize telescope options on page load
        updateTelescopeOptions();

        // Toggle collapsible section
        function toggleCollapsible(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const toggle = document.getElementById(sectionId + '-toggle');

            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        function tryNextNight() {
            // Get current date from input
            const dateInput = document.getElementById('observing-date');
            const currentDate = new Date(dateInput.value);

            // Add one day
            currentDate.setDate(currentDate.getDate() + 1);

            // Update the input field
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            // Regenerate the plan
            generatePlan();
        }

        // Check conditions and show forecast before generating a plan
        async function checkPrePlanWeather() {
            const forecastEl = document.getElementById('pre-plan-forecast');
            const loadingEl = document.getElementById('forecast-loading');
            const contentEl = document.getElementById('forecast-content');
            const summaryEl = document.getElementById('forecast-summary');
            const actionEl = document.getElementById('forecast-action');

            // Get location and date
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            const observingDate = document.getElementById('observing-date').value;
            const timezone = document.getElementById('timezone').value;

            // Remove previous state classes
            forecastEl.classList.remove('excellent', 'good', 'fair', 'poor');

            // Validate we have location
            if (isNaN(latitude) || isNaN(longitude) || !observingDate) {
                loadingEl.style.display = 'block';
                loadingEl.textContent = 'Enter location to see forecast';
                contentEl.style.display = 'none';
                return;
            }

            loadingEl.style.display = 'block';
            loadingEl.textContent = 'Checking conditions...';
            contentEl.style.display = 'none';

            try {
                // Fetch twilight data to get night duration
                const twilightResponse = await fetch(`/api/twilight?date=${observingDate}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Location',
                        latitude: latitude,
                        longitude: longitude,
                        elevation: 0,
                        timezone: timezone
                    })
                });

                let nightMinutes = 480; // Default 8 hours
                if (twilightResponse.ok) {
                    const twilight = await twilightResponse.json();
                    const astroEnd = new Date(twilight.astronomical_twilight_end);
                    const astroStart = new Date(twilight.astronomical_twilight_start);
                    nightMinutes = Math.round((astroStart - astroEnd) / 60000);
                }

                // Fetch astronomy weather forecast
                const weatherResponse = await fetch(`/api/weather/astronomy?lat=${latitude}&lon=${longitude}&hours=12&date=${observingDate}`);

                let avgScore = 70; // Default to decent if no weather data
                let avgCloudCover = 30;
                let weatherAvailable = false;

                if (weatherResponse.ok) {
                    const data = await weatherResponse.json();
                    if (data.forecast && data.forecast.length > 0) {
                        weatherAvailable = true;
                        avgScore = data.forecast.reduce((sum, f) => sum + f.astronomy_score, 0) / data.forecast.length * 100;
                        avgCloudCover = data.forecast.reduce((sum, f) => sum + (f.cloud_cover || 0), 0) / data.forecast.length;
                    }
                }

                // Calculate estimates based on conditions
                const setupTime = parseInt(document.getElementById('setup-time').value) || 30;
                const usableMinutes = Math.max(0, nightMinutes - setupTime);

                // Estimate successful observing time based on weather
                const weatherFactor = avgScore / 100;
                const successfulMinutes = Math.round(usableMinutes * weatherFactor);

                // Estimate targets (roughly 45-90 min per target depending on mode)
                const planningMode = document.getElementById('planning-mode').value;
                const avgTargetTime = planningMode === 'quality' ? 90 : planningMode === 'quantity' ? 45 : 60;
                const estimatedTargets = Math.max(1, Math.floor(successfulMinutes / avgTargetTime));

                // Determine condition category
                let category, statusIcon, statusText, statusColor;
                if (avgScore >= 70) {
                    category = 'excellent';
                    statusIcon = '‚ú®';
                    statusText = 'Excellent conditions';
                    statusColor = '#10b981';
                } else if (avgScore >= 50) {
                    category = 'good';
                    statusIcon = 'üëç';
                    statusText = 'Good conditions';
                    statusColor = '#00d9ff';
                } else if (avgScore >= 30) {
                    category = 'fair';
                    statusIcon = '‚ö†Ô∏è';
                    statusText = 'Fair conditions';
                    statusColor = '#f97316';
                } else {
                    category = 'poor';
                    statusIcon = '‚ùå';
                    statusText = 'Poor conditions';
                    statusColor = '#ef4444';
                }

                forecastEl.classList.add(category);

                // Build summary HTML
                const hoursStr = Math.floor(successfulMinutes / 60);
                const minsStr = successfulMinutes % 60;
                const timeStr = hoursStr > 0 ? `${hoursStr}h ${minsStr}m` : `${minsStr}m`;

                summaryEl.innerHTML = `
                    <span style="color: ${statusColor}; font-weight: bold;">${statusIcon} ${statusText}</span>
                    ${weatherAvailable ? `<span style="color: #94a3b8;"> ¬∑ ${avgCloudCover.toFixed(0)}% clouds</span>` : ''}
                    <br>
                    <span style="color: #cbd5e1;">Est. <strong style="color: ${statusColor};">${estimatedTargets}</strong> targets across <strong style="color: ${statusColor};">${timeStr}</strong> of successful imaging</span>
                `;

                // Build action HTML
                if (avgScore < 40) {
                    actionEl.innerHTML = `<button class="btn btn-small" style="background: ${statusColor}; color: white;" onclick="skipToNextGoodNight()">Find Better Night ‚Üí</button>`;
                } else {
                    actionEl.innerHTML = '';
                }

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

            } catch (error) {
                console.error('Error checking pre-plan conditions:', error);
                loadingEl.textContent = 'Could not load forecast';
                contentEl.style.display = 'none';
            }
        }

        // Skip to next night with good weather
        async function skipToNextGoodNight() {
            const dateInput = document.getElementById('observing-date');
            const latitude = parseFloat(document.getElementById('latitude').value);
            const longitude = parseFloat(document.getElementById('longitude').value);
            let currentDate = new Date(dateInput.value);

            // Show searching state
            const loadingEl = document.getElementById('forecast-loading');
            const contentEl = document.getElementById('forecast-content');
            loadingEl.style.display = 'block';
            loadingEl.textContent = 'Searching for clear skies...';
            contentEl.style.display = 'none';

            // Try up to 7 days ahead
            for (let i = 0; i < 7; i++) {
                currentDate.setDate(currentDate.getDate() + 1);
                const dateStr = currentDate.toISOString().split('T')[0];

                try {
                    const response = await fetch(`/api/weather/astronomy?lat=${latitude}&lon=${longitude}&hours=12&date=${dateStr}`);
                    if (!response.ok) continue;

                    const data = await response.json();
                    if (!data.forecast || data.forecast.length === 0) continue;

                    const avgScore = data.forecast.reduce((sum, f) => sum + f.astronomy_score, 0) / data.forecast.length * 100;

                    if (avgScore >= 45) {
                        // Found a good night
                        dateInput.value = dateStr;
                        checkPrePlanWeather();
                        return;
                    }
                } catch (error) {
                    console.error('Error checking future weather:', error);
                }
            }

            // No good night found in next 7 days, just advance by one day
            const nextDate = new Date(document.getElementById('observing-date').value);
            nextDate.setDate(nextDate.getDate() + 1);
            dateInput.value = nextDate.toISOString().split('T')[0];
            checkPrePlanWeather();
        }

        async function generatePlan() {
            // Get form values
            const location = {
                name: document.getElementById('location-name').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                elevation: parseFloat(document.getElementById('elevation').value) * 0.3048, // Convert feet to meters
                timezone: document.getElementById('timezone').value
            };

            const observingDate = document.getElementById('observing-date').value;

            const objectTypes = [];
            // Only get object type checkboxes (type-*)
            document.querySelectorAll('input[id^="type-"]:checked').forEach(cb => {
                objectTypes.push(cb.value);
            });

            const planningMode = document.getElementById('planning-mode').value;
            const daytimePlanning = document.getElementById('daytime-planning').checked;

            const constraints = {
                min_altitude: parseFloat(document.getElementById('min-altitude').value),
                max_altitude: parseFloat(document.getElementById('max-altitude').value),
                setup_time_minutes: parseInt(document.getElementById('setup-time').value),
                object_types: objectTypes,
                planning_mode: planningMode,
                daytime_planning: daytimePlanning
            };

            const request = {
                location: location,
                observing_date: observingDate,
                constraints: constraints
            };

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('error').classList.remove('active');

            try {
                const response = await fetch('/api/plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const plan = await response.json();
                currentPlan = plan;
                displayPlan(plan);

                // Update plan selection UI in Observe tab
                if (typeof updatePlanSelectionUI === 'function') {
                    updatePlanSelectionUI();
                }

                // Hide loading, show results
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');

                // Collapse the preferences section to focus on results
                const preferencesContent = document.getElementById('preferences-content');
                const preferencesToggle = document.getElementById('preferences-toggle');
                if (preferencesContent && !preferencesContent.classList.contains('collapsed')) {
                    preferencesContent.classList.add('collapsed');
                    preferencesToggle.classList.add('collapsed');
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').classList.remove('active');
                const errorEl = document.getElementById('error');
                errorEl.textContent = `Error generating plan: ${error.message}`;
                errorEl.classList.add('active');
            }
        }

        async function displayPlan(plan) {
            // Calculate average weather score from scheduled targets
            let avgWeatherScore = 0;
            if (plan.scheduled_targets.length > 0) {
                const totalWeatherScore = plan.scheduled_targets.reduce((sum, st) => sum + st.score.weather_score, 0);
                avgWeatherScore = totalWeatherScore / plan.scheduled_targets.length;
            }

            // Check if weather is bad (score < 0.4)
            const weatherWarning = document.getElementById('weather-warning');
            const weatherWarningText = document.getElementById('weather-warning-text');

            if (avgWeatherScore < 0.4 && plan.scheduled_targets.length > 0) {
                const avgCloudCover = plan.weather_forecast.length > 0
                    ? (plan.weather_forecast.reduce((a,b) => a + b.cloud_cover, 0) / plan.weather_forecast.length).toFixed(0)
                    : 'unknown';

                weatherWarningText.innerHTML = `
                    The weather conditions for <strong>${plan.session.observing_date}</strong> are poor for astrophotography.
                    Average cloud cover: ${avgCloudCover}%, Weather quality score: ${(avgWeatherScore * 100).toFixed(0)}%.
                    Consider trying another night for better results.
                `;
                weatherWarning.classList.add('active');
            } else {
                weatherWarning.classList.remove('active');
            }

            // Calculate and display Plan Success Banner
            const successBanner = document.getElementById('plan-success-banner');
            const successTitle = document.getElementById('success-banner-title');
            const successScore = document.getElementById('success-banner-score');
            const successDetails = document.getElementById('success-banner-details');

            // Remove all previous state classes
            successBanner.classList.remove('excellent', 'good', 'fair', 'poor', 'active');

            // Calculate overall success chance based on multiple factors
            const avgCloudCoverForBanner = plan.weather_forecast.length > 0
                ? plan.weather_forecast.reduce((a,b) => a + b.cloud_cover, 0) / plan.weather_forecast.length
                : 50;
            const avgHumidity = plan.weather_forecast.length > 0
                ? plan.weather_forecast.reduce((a,b) => a + b.humidity, 0) / plan.weather_forecast.length
                : 50;

            // Weather score (0-100): lower cloud cover and humidity = better
            const cloudScore = Math.max(0, 100 - avgCloudCoverForBanner);
            const humidityScore = Math.max(0, 100 - (avgHumidity * 0.5)); // Humidity less impactful
            const weatherScorePercent = avgWeatherScore * 100;

            // Target availability score (based on coverage)
            const coverageScore = plan.coverage_percent;

            // Combined success score (weighted average)
            const successChance = Math.round(
                (weatherScorePercent * 0.5) +  // Weather is most important
                (cloudScore * 0.25) +           // Cloud cover
                (coverageScore * 0.15) +        // How well the night is used
                (humidityScore * 0.10)          // Humidity
            );

            // Determine category and messaging
            let category, title, details;
            if (successChance >= 75) {
                category = 'excellent';
                title = 'Excellent Observing Night!';
                details = `Clear skies and great conditions predicted. ${plan.total_targets} targets scheduled with ${plan.coverage_percent.toFixed(0)}% night coverage.`;
            } else if (successChance >= 55) {
                category = 'good';
                title = 'Good Observing Conditions';
                details = `Favorable conditions expected. ${plan.total_targets} targets can be imaged with ${avgCloudCoverForBanner.toFixed(0)}% average cloud cover.`;
            } else if (successChance >= 35) {
                category = 'fair';
                title = 'Fair Conditions - Some Risk';
                details = `Mixed conditions expected. Consider monitoring weather closely. ${avgCloudCoverForBanner.toFixed(0)}% cloud cover, ${avgHumidity.toFixed(0)}% humidity.`;
            } else {
                category = 'poor';
                title = 'Challenging Conditions';
                details = `Weather may impact imaging quality. High cloud cover (${avgCloudCoverForBanner.toFixed(0)}%) or humidity (${avgHumidity.toFixed(0)}%). Consider rescheduling.`;
            }

            successTitle.textContent = title;
            successScore.textContent = `${successChance}% Success Chance`;
            successDetails.textContent = details;
            successBanner.classList.add(category, 'active');

            // Fetch astronomy data (sky quality and detailed weather)
            let skyQualityHtml = '';
            let astronomyWeatherHtml = '';
            let satelliteWarningHtml = '';

            try {
                const latitude = parseFloat(document.getElementById('latitude').value);
                const longitude = parseFloat(document.getElementById('longitude').value);

                // Use sky quality from plan if available, otherwise fetch from API
                let skyQuality = plan.sky_quality;
                if (!skyQuality) {
                    const skyQualityResponse = await fetch(`/api/sky-quality/${latitude}/${longitude}`);
                    if (skyQualityResponse.ok) {
                        skyQuality = await skyQualityResponse.json();
                    }
                }

                if (skyQuality) {
                    const bortleColor = skyQuality.bortle_class <= 3 ? '#4ade80' :
                                       skyQuality.bortle_class <= 5 ? '#fbbf24' : '#ef4444';
                    const filteredNote = skyQuality.suitable_for && skyQuality.suitable_for.length < 8 ?
                        '<div style="font-size: 0.85em; opacity: 0.8; margin-top: 3px;">Targets filtered by sky quality</div>' : '';
                    skyQualityHtml = `
                        <div class="summary-item" style="grid-column: span 2;">
                            <strong>Sky Quality</strong>
                            <div style="margin-top: 5px;">
                                Bortle <span style="color: ${bortleColor}; font-weight: bold;">${skyQuality.bortle_class}</span>
                                (${skyQuality.bortle_name}) -
                                SQM ${skyQuality.sqm_estimate.toFixed(1)} mag/arcsec¬≤ -
                                ${skyQuality.milky_way_visibility}
                                ${filteredNote}
                            </div>
                        </div>
                    `;
                }

                // Fetch ClearDarkSky astronomy weather
                const astroWeatherResponse = await fetch(`/api/weather/astronomy?lat=${latitude}&lon=${longitude}&hours=12`);
                if (astroWeatherResponse.ok) {
                    const astroWeather = await astroWeatherResponse.json();
                    if (astroWeather.forecast && astroWeather.forecast.length > 0) {
                        // Calculate averages for the session
                        const avgScore = (astroWeather.forecast.reduce((a,b) => a + b.astronomy_score, 0) / astroWeather.forecast.length * 100).toFixed(0);
                        const avgTransparency = astroWeather.forecast[0].transparency;
                        const avgSeeing = astroWeather.forecast[0].seeing;

                        const scoreColor = avgScore >= 70 ? '#4ade80' : avgScore >= 40 ? '#fbbf24' : '#ef4444';
                        astronomyWeatherHtml = `
                            <div class="summary-item" style="grid-column: span 2;">
                                <strong>Astronomy Conditions</strong>
                                <div style="margin-top: 5px;">
                                    Quality Score: <span style="color: ${scoreColor}; font-weight: bold;">${avgScore}%</span> -
                                    Transparency: ${avgTransparency} -
                                    Seeing: ${avgSeeing}
                                </div>
                            </div>
                        `;
                    }
                }

                // Fetch ISS passes and check for conflicts with imaging window
                const issResponse = await fetch(`/api/satellites/iss?lat=${latitude}&lon=${longitude}&days=1`);
                if (issResponse.ok) {
                    const issData = await issResponse.json();
                    if (issData.passes && issData.passes.length > 0) {
                        // Parse imaging window times
                        const imagingStart = new Date(plan.session.imaging_start);
                        const imagingEnd = new Date(plan.session.imaging_end);

                        // Find passes that overlap with imaging window
                        const conflictingPasses = issData.passes.filter(pass => {
                            const passStart = new Date(pass.start_time);
                            const passEnd = new Date(pass.end_time);
                            // Check if pass overlaps with imaging window
                            return passStart < imagingEnd && passEnd > imagingStart;
                        });

                        if (conflictingPasses.length > 0) {
                            const passList = conflictingPasses.map(pass => {
                                const passTime = new Date(pass.start_time);
                                return `${passTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} (${pass.max_altitude_deg.toFixed(0)}¬∞, ${pass.duration_minutes.toFixed(0)}min)`;
                            }).join(', ');

                            satelliteWarningHtml = `
                                <div class="summary-item" style="grid-column: span 2; background: #fef3c7; padding: 10px; border-left: 3px solid #f59e0b;">
                                    <strong style="color: #92400e;">‚ö†Ô∏è ISS Pass Warning</strong>
                                    <div style="margin-top: 5px; color: #78350f;">
                                        ${conflictingPasses.length} ISS pass(es) during imaging window: ${passList}
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching astronomy data:', error);
            }

            // Display session summary
            const summaryHtml = `
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>Observing Date</strong>
                        ${plan.session.observing_date}
                    </div>
                    <div class="summary-item">
                        <strong>Astronomical Twilight</strong>
                        ${formatTime(plan.session.astronomical_twilight_end)} - ${formatTime(plan.session.astronomical_twilight_start)}
                    </div>
                    <div class="summary-item">
                        <strong>Imaging Window</strong>
                        ${formatTime(plan.session.imaging_start)} - ${formatTime(plan.session.imaging_end)}
                    </div>
                    <div class="summary-item">
                        <strong>Total Imaging Time</strong>
                        ${plan.session.total_imaging_minutes} minutes
                    </div>
                    <div class="summary-item">
                        <strong>Total Targets</strong>
                        ${plan.total_targets}
                    </div>
                    <div class="summary-item">
                        <strong>Night Coverage</strong>
                        ${plan.coverage_percent.toFixed(1)}%
                    </div>
                    ${skyQualityHtml}
                    ${astronomyWeatherHtml}
                    ${satelliteWarningHtml}
                </div>

                <div class="weather-forecast">
                    <strong>Weather Forecast</strong>
                    ${plan.weather_forecast.length > 0 ? (() => {
                        const avgCloudCover = (plan.weather_forecast.reduce((a,b) => a + b.cloud_cover, 0) / plan.weather_forecast.length).toFixed(0);
                        const avgHumidity = (plan.weather_forecast.reduce((a,b) => a + b.humidity, 0) / plan.weather_forecast.length).toFixed(0);

                        // Check if we have astronomy-specific data (seeing, transparency)
                        const hasAstronomyData = plan.weather_forecast.some(f => f.seeing_arcseconds != null);

                        let astronomyMetrics = '';
                        if (hasAstronomyData) {
                            // Filter forecasts that have astronomy data
                            const astroForecasts = plan.weather_forecast.filter(f => f.seeing_arcseconds != null);
                            if (astroForecasts.length > 0) {
                                const avgSeeing = (astroForecasts.reduce((a,b) => a + b.seeing_arcseconds, 0) / astroForecasts.length).toFixed(1);
                                const avgTransparency = (astroForecasts.reduce((a,b) => a + b.transparency_magnitude, 0) / astroForecasts.length).toFixed(1);
                                astronomyMetrics = `<br>Seeing: ${avgSeeing}" (arcsec), Transparency: mag ${avgTransparency}`;
                            }
                        }

                        return `<p>Cloud Cover: ${avgCloudCover}%, Humidity: ${avgHumidity}%${astronomyMetrics}</p>`;
                    })() : '<p>No weather data available</p>'}
                </div>
            `;
            document.getElementById('session-summary').innerHTML = summaryHtml;

            // Add plan overview chart section
            const planChartHtml = plan.scheduled_targets.length > 0 ? `
                <div style="margin: 30px 0; padding: 20px; background: var(--tron-panel); border: 1px solid var(--tron-border); border-radius: 8px;">
                    <h3 style="color: var(--tron-cyan); margin-bottom: 15px;">üìà Complete Plan Altitude Graph</h3>
                    <div style="margin-top: 15px;">
                        <canvas id="plan-altitude-chart" style="max-height: 400px;"></canvas>
                    </div>
                </div>
            ` : '';

            // Insert plan chart before targets
            const resultsDiv = document.getElementById('results');
            const sessionSummary = document.getElementById('session-summary');
            if (sessionSummary && !document.getElementById('plan-altitude-chart-container')) {
                const chartContainer = document.createElement('div');
                chartContainer.id = 'plan-altitude-chart-container';
                chartContainer.innerHTML = planChartHtml;
                sessionSummary.insertAdjacentElement('afterend', chartContainer);
            }

            // Display targets
            const targetsHtml = plan.scheduled_targets.map((st, i) => {
                // Convert RA hours to degrees for preview
                const raDeg = st.target.ra_hours ? (st.target.ra_hours * 15).toFixed(4) : null;
                const sizeArcmin = st.target.size_arcmin || 60;

                // Auto-generate preview image URL if not already set
                if (!st.target.image_url && st.target.catalog_id) {
                    const sanitizedId = st.target.catalog_id.replace(/ /g, '_').replace(/\//g, '_').replace(/:/g, '_');
                    st.target.image_url = `/api/images/targets/${sanitizedId}`;
                }

                // Image preview section
                const imageHtml = st.target.image_url ? `
                    <div style="margin-bottom: 12px;">
                        <img src="${st.target.image_url}"
                             alt="${st.target.name} preview"
                             style="width: 100%; max-width: 300px; height: auto; border-radius: 6px; border: 2px solid var(--tron-border); cursor: pointer;"
                             onclick="showObjectPreview('${st.target.name}', '${st.target.catalog_id}', ${raDeg}, ${st.target.dec_degrees}, ${sizeArcmin})"
                             onerror="this.style.display='none'">
                    </div>
                ` : '';

                return `
                <div class="target-card" id="target-card-${i}">
                    <div class="target-header">
                        <div>
                            <div class="target-name">${i+1}. ${st.target.name} (${st.target.catalog_id}) <span class="target-score">- Score: ${st.score.total_score.toFixed(2)}</span></div>
                        </div>
                        <div class="target-type">${st.target.object_type}</div>
                    </div>

                    ${imageHtml}

                    <div class="target-details">
                        <div class="detail-item">
                            <strong>Time:</strong> ${formatTime(st.start_time)} - ${formatTime(st.end_time)} (${st.duration_minutes} min)
                        </div>
                        <div class="detail-item">
                            <strong>Altitude:</strong> ${st.start_altitude.toFixed(1)}¬∞ ‚Üí ${st.end_altitude.toFixed(1)}¬∞
                        </div>
                        <div class="detail-item">
                            <strong>Azimuth:</strong> ${st.start_azimuth.toFixed(1)}¬∞ ‚Üí ${st.end_azimuth.toFixed(1)}¬∞
                        </div>
                        <div class="detail-item">
                            <strong>Field Rotation:</strong> ${st.field_rotation_rate.toFixed(2)}¬∞/min
                        </div>
                        <div class="detail-item">
                            <strong>Exposure:</strong> ${st.recommended_exposure}s √ó ${st.recommended_frames} frames
                        </div>
                    </div>
                    ${st.target.description ? `<p style="margin-top:10px; font-style:italic;">${st.target.description}</p>` : ''}

                    <!-- Action Buttons -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--tron-border); display: flex; gap: 10px;">
                        <button class="preview-btn" onclick="showAltitudeChart(${i})" style="flex: 1;">
                            üìä Altitude Graph
                        </button>
                        ${raDeg && st.target.dec_degrees ? `
                            <button class="preview-btn" onclick="showObjectPreview('${st.target.name}', '${st.target.catalog_id}', ${raDeg}, ${st.target.dec_degrees}, ${sizeArcmin})" style="flex: 1;">
                                üî≠ Preview Object
                            </button>
                        ` : ''}
                    </div>
                </div>
                `;
            }).join('');

            // Display helpful message if no targets
            if (!targetsHtml) {
                const noTargetsMessage = `
                    <div style="padding: 20px; text-align: center; background: var(--tron-panel); border: 1px solid var(--tron-border); border-radius: 8px;">
                        <h3 style="color: var(--tron-cyan); margin-bottom: 15px;">No Targets Found</h3>
                        <p style="margin-bottom: 10px;">No suitable targets are visible for the selected date and constraints.</p>
                        <p style="opacity: 0.8; font-size: 0.9em;">This could be because:</p>
                        <ul style="text-align: left; max-width: 500px; margin: 10px auto; opacity: 0.8; font-size: 0.9em;">
                            <li>The selected object types are not visible tonight at your location</li>
                            <li>No objects meet the altitude constraints (${document.getElementById('min-altitude').value}¬∞ - ${document.getElementById('max-altitude').value}¬∞)</li>
                            <li>It's currently daytime (try enabling "Daytime Planning" or select a different date)</li>
                            <li>Your location's latitude makes certain objects circumpolar or never visible</li>
                        </ul>
                        <p style="margin-top: 15px; opacity: 0.8; font-size: 0.9em;">
                            <strong>Try:</strong> Adjusting the altitude constraints, selecting different object types, or choosing a different date.
                        </p>
                    </div>
                `;
                document.getElementById('target-list').innerHTML = noTargetsMessage;
            } else {
                document.getElementById('target-list').innerHTML = targetsHtml;
            }

            // Render plan overview chart if we have targets
            if (plan.scheduled_targets.length > 0) {
                setTimeout(() => renderPlanAltitudeChart(plan), 200);
            }
        }

        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        async function exportPlan(format) {
            if (!currentPlan) {
                alert('Please generate a plan first');
                return;
            }

            try {
                const response = await fetch(`/api/export?format=${format}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentPlan)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Download file
                const blob = new Blob([result.data], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `observing_plan_${currentPlan.session.observing_date}.${getFileExtension(format)}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error:', error);
                alert(`Error exporting plan: ${error.message}`);
            }
        }

        function getFileExtension(format) {
            const extensions = {
                'json': 'json',
                'seestar_plan': 'json',
                'seestar_alp': 'csv',  // CSV format for seestar_alp import
                'text': 'txt',
                'csv': 'csv'
            };
            return extensions[format] || 'txt';
        }

        async function showQRCode() {
            if (!currentPlan) {
                alert('Please generate a plan first');
                return;
            }

            try {
                // Save plan to server and get shareable URL
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentPlan)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Create full URL
                const shareUrl = `${window.location.origin}/plan/${result.plan_id}`;

                // Clear previous QR code
                const qrContainer = document.getElementById('qr-code');
                qrContainer.innerHTML = '';

                // Create QR code with the shareable URL
                new QRCode(qrContainer, {
                    text: shareUrl,
                    width: 256,
                    height: 256,
                    colorDark: '#667eea',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                // Show modal
                document.getElementById('qr-modal').style.display = 'block';

            } catch (error) {
                console.error('Error generating QR code:', error);
                alert(`Error generating QR code: ${error.message}`);
            }
        }

        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // Object preview functions
        let aladinInstance = null;

        function showObjectPreview(name, catalogId, raDeg, decDeg, sizeArcmin) {
            const modal = document.getElementById('preview-modal');
            const title = document.getElementById('preview-title');

            // Update title
            title.textContent = `üî≠ ${name} (${catalogId})`;

            // Update resource links
            document.getElementById('simbad-link').href = `http://simbad.u-strasbg.fr/simbad/sim-id?Ident=${encodeURIComponent(catalogId)}`;
            document.getElementById('wikisky-link').href = `http://www.wikisky.org/?ra=${raDeg}&de=${decDeg}&zoom=9&img_source=DSS2`;
            document.getElementById('astrobin-link').href = `https://www.astrobin.com/search/?q=${encodeURIComponent(name)}`;

            // Show modal
            modal.style.display = 'block';

            // Initialize Aladin Lite viewer
            setTimeout(() => {
                try {
                    const aladinDiv = document.getElementById('aladin-lite-div');

                    // Calculate FOV based on object size (with some padding)
                    const fov = Math.max(sizeArcmin / 60 * 2, 0.5); // At least 0.5 degrees

                    // Initialize or reuse Aladin instance
                    if (!aladinInstance) {
                        aladinInstance = A.aladin(aladinDiv, {
                            survey: 'P/DSS2/color',
                            fov: fov,
                            target: `${raDeg} ${decDeg}`,
                            showReticle: true,
                            showZoomControl: true,
                            showFullscreenControl: true,
                            showLayersControl: true,
                            showGotoControl: false,
                            showShareControl: false,
                            showCatalog: true,
                            reticleColor: '#00d9ff',
                            reticleSize: 32
                        });
                    } else {
                        aladinInstance.gotoRaDec(raDeg, decDeg);
                        aladinInstance.setFoV(fov);
                    }
                } catch (error) {
                    console.error('Error initializing Aladin Lite:', error);
                    document.getElementById('aladin-lite-div').innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #f1f5f9; text-align: center;">
                            <div>
                                <p style="margin-bottom: 10px;">‚ö†Ô∏è Sky viewer failed to load</p>
                                <p style="font-size: 0.9em; opacity: 0.8;">Use the resource links below to view this object</p>
                            </div>
                        </div>
                    `;
                }
            }, 100);
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').style.display = 'none';
        }

        // Target altitude chart modal functions
        let altitudeChartInstance = null;
        let planChartInstance = null;

        function showAltitudeChart(targetIndex) {
            if (!currentPlan || !currentPlan.scheduled_targets[targetIndex]) {
                console.error('Target not found');
                return;
            }

            const st = currentPlan.scheduled_targets[targetIndex];
            const modal = document.getElementById('altitude-modal');
            const title = document.getElementById('altitude-modal-title');

            // Update title
            title.textContent = `${st.target.name} (${st.target.catalog_id}) - Altitude Graph`;

            // Update metadata section
            const metadata = document.getElementById('altitude-modal-metadata');
            metadata.innerHTML = `
                <div><strong>Object Type:</strong> ${st.target.object_type}</div>
                <div><strong>RA:</strong> ${st.target.ra_hours.toFixed(4)}h</div>
                <div><strong>Dec:</strong> ${st.target.dec_degrees.toFixed(2)}¬∞</div>
                <div><strong>Magnitude:</strong> ${st.target.magnitude.toFixed(1)}</div>
                <div><strong>Size:</strong> ${st.target.size_arcmin.toFixed(1)}'</div>
                <div><strong>Duration:</strong> ${st.duration_minutes} min</div>
                <div><strong>Visibility Score:</strong> ${(st.score.visibility_score * 100).toFixed(0)}%</div>
                <div><strong>Weather Score:</strong> ${(st.score.weather_score * 100).toFixed(0)}%</div>
                <div><strong>Total Score:</strong> ${(st.score.total_score * 100).toFixed(0)}%</div>
            `;

            // Update info section
            const info = document.getElementById('altitude-modal-info');
            info.innerHTML = `
                <strong>Imaging Window:</strong> ${formatTime(st.start_time)} - ${formatTime(st.end_time)}<br>
                <strong>Altitude Range:</strong> ${st.start_altitude.toFixed(1)}¬∞ ‚Üí ${st.end_altitude.toFixed(1)}¬∞<br>
                <strong>Field Rotation Rate:</strong> ${st.field_rotation_rate.toFixed(2)}¬∞/min
            `;

            // Show modal
            modal.style.display = 'block';

            // Render chart
            setTimeout(() => renderAltitudeChart(st), 100);
        }

        function renderAltitudeChart(scheduledTarget) {
            const ctx = document.getElementById('altitude-chart');

            // Destroy previous chart if exists
            if (altitudeChartInstance) {
                altitudeChartInstance.destroy();
            }

            // Prepare data from altitude_points
            const dataPoints = scheduledTarget.altitude_points.map(point => ({
                x: new Date(point[0]),
                y: point[1]
            }));

            console.log(`Rendering altitude chart for ${scheduledTarget.target.name}:`,
                        `${dataPoints.length} points, altitude range ${Math.min(...dataPoints.map(p => p.y)).toFixed(1)}¬∞ - ${Math.max(...dataPoints.map(p => p.y)).toFixed(1)}¬∞`);

            // Create chart
            altitudeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Altitude (¬∞)',
                        data: dataPoints,
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#00d9ff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Target Altitude During Imaging Session',
                            color: '#00d9ff',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Altitude: ${context.parsed.y.toFixed(1)}¬∞`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time (Local)',
                                color: '#cbd5e1'
                            },
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Altitude (degrees)',
                                color: '#cbd5e1'
                            },
                            min: 0,
                            max: 90,
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value + '¬∞';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function closeAltitudeModal() {
            document.getElementById('altitude-modal').style.display = 'none';
            if (altitudeChartInstance) {
                altitudeChartInstance.destroy();
                altitudeChartInstance = null;
            }
        }

        // Plan overview altitude chart
        function renderPlanAltitudeChart(plan) {
            const ctx = document.getElementById('plan-altitude-chart');

            if (!ctx) {
                console.error('Plan chart canvas not found');
                return;
            }

            // Destroy previous chart if exists
            if (planChartInstance) {
                planChartInstance.destroy();
            }

            // Prepare datasets for each target
            const datasets = plan.scheduled_targets.map((st, index) => {
                // Generate color from index
                const hue = (index * 360 / plan.scheduled_targets.length) % 360;
                const color = `hsl(${hue}, 70%, 60%)`;

                const dataPoints = st.altitude_points.map(point => ({
                    x: new Date(point[0]),
                    y: point[1]
                }));

                return {
                    label: `${st.target.name} (${st.target.catalog_id})`,
                    data: dataPoints,
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    tension: 0.4,
                    targetIndex: index  // Store index for click handling
                };
            });

            console.log(`Rendering plan altitude chart with ${datasets.length} targets`);

            // Create chart
            planChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#cbd5e1',
                                font: { size: 11 },
                                padding: 10,
                                usePointStyle: true
                            },
                            onClick: function(e, legendItem, legend) {
                                // Highlight corresponding target card when clicking legend
                                const targetIndex = datasets[legendItem.datasetIndex].targetIndex;
                                highlightTargetCard(targetIndex);
                            }
                        },
                        title: {
                            display: true,
                            text: 'All Targets Altitude Timeline',
                            color: '#00d9ff',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}¬∞`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time (Local)',
                                color: '#cbd5e1'
                            },
                            ticks: {
                                color: '#94a3b8'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Altitude (degrees)',
                                color: '#cbd5e1'
                            },
                            min: 0,
                            max: 90,
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value + '¬∞';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        // Click on line to highlight target card
                        if (elements.length > 0) {
                            const datasetIndex = elements[0].datasetIndex;
                            const targetIndex = datasets[datasetIndex].targetIndex;
                            highlightTargetCard(targetIndex);
                        }
                    }
                }
            });
        }

        function highlightTargetCard(targetIndex) {
            // Remove previous highlights
            document.querySelectorAll('.target-card').forEach(card => {
                card.style.border = '';
                card.style.boxShadow = '';
            });

            // Highlight selected card
            const card = document.getElementById(`target-card-${targetIndex}`);
            if (card) {
                card.style.border = '3px solid #00d9ff';
                card.style.boxShadow = '0 0 20px rgba(0, 217, 255, 0.5)';

                // Scroll to card
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Remove highlight after 3 seconds
                setTimeout(() => {
                    card.style.border = '';
                    card.style.boxShadow = '';
                }, 3000);
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const altModal = document.getElementById('altitude-modal');
                if (altModal && altModal.style.display === 'block') {
                    closeAltitudeModal();
                }
            }
        });

        // Save Plan Modal Functions
        function showSavePlanModal() {
            if (!currentPlan) {
                alert('No plan available to save. Please generate a plan first.');
                return;
            }

            // Reset form
            document.getElementById('plan-name').value = '';
            document.getElementById('plan-description').value = '';
            document.getElementById('save-plan-error').style.display = 'none';
            document.querySelector('.save-plan-form').style.display = 'block';
            document.getElementById('save-plan-success').style.display = 'none';

            // Show modal
            document.getElementById('save-plan-modal').style.display = 'block';

            // Add keyboard event listener
            document.addEventListener('keydown', handleSavePlanKeydown);

            // Focus on plan name input
            setTimeout(() => {
                document.getElementById('plan-name').focus();
            }, 100);
        }

        function handleSavePlanKeydown(event) {
            const modal = document.getElementById('save-plan-modal');
            if (modal.style.display === 'block') {
                if (event.key === 'Escape') {
                    closeSavePlanModal();
                } else if (event.key === 'Enter' && event.target.tagName !== 'TEXTAREA') {
                    event.preventDefault();
                    savePlan();
                }
            }
        }

        function closeSavePlanModal() {
            document.getElementById('save-plan-modal').style.display = 'none';
            // Remove keyboard event listener
            document.removeEventListener('keydown', handleSavePlanKeydown);
        }

        async function savePlan() {
            const planName = document.getElementById('plan-name').value.trim();
            const planDescription = document.getElementById('plan-description').value.trim();
            const errorDiv = document.getElementById('save-plan-error');

            // Validate plan name
            if (!planName) {
                errorDiv.textContent = 'Plan name is required.';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate that we have a current plan
            if (!currentPlan) {
                errorDiv.textContent = 'No plan available to save. Please generate a plan first.';
                errorDiv.style.display = 'block';
                return;
            }

            // Hide error
            errorDiv.style.display = 'none';

            // Prepare the save request
            const saveRequest = {
                name: planName,
                description: planDescription || null,
                plan: currentPlan
            };

            try {
                const response = await fetch('/api/plans/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saveRequest)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const savedPlan = await response.json();
                console.log('Plan saved successfully:', savedPlan);

                // Show success message
                document.querySelector('.save-plan-form').style.display = 'none';
                document.getElementById('save-plan-success').style.display = 'block';

            } catch (error) {
                console.error('Error saving plan:', error);
                errorDiv.textContent = `Error saving plan: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // ======================
        // Plan Selection Functions
        // ======================

        function updatePlanSelectionUI() {
            const liveCard = document.getElementById('plan-option-live');
            const loadCard = document.getElementById('plan-option-load');
            const createCard = document.getElementById('plan-option-create');
            const planInfo = document.getElementById('current-plan-info');
            const executeBtn = document.getElementById('execute-btn-main');

            // Remove all active states
            liveCard.classList.remove('active');
            loadCard.classList.remove('active');
            createCard.classList.remove('active');

            // Remove any existing badges
            document.querySelectorAll('.plan-status-badge').forEach(badge => badge.remove());

            if (currentPlan && currentPlan.scheduled_targets && currentPlan.scheduled_targets.length > 0) {
                // Mark the live session card as active
                liveCard.classList.add('active');

                // Add "Ready" badge to live card
                const badge = document.createElement('span');
                badge.className = 'plan-status-badge';
                badge.textContent = 'Ready';
                liveCard.appendChild(badge);

                // Show plan info banner
                planInfo.style.display = 'block';
                document.getElementById('current-plan-name').textContent = currentPlan.name || 'Current Plan';
                document.getElementById('current-plan-target-count').textContent = currentPlan.scheduled_targets.length;
                document.getElementById('current-plan-location').textContent =
                    currentPlan.session?.location || 'Unknown';

                // Enable execute button (if connected)
                if (executeBtn && !executeBtn.disabled) {
                    executeBtn.disabled = false;
                }
            } else {
                // Hide plan info banner
                planInfo.style.display = 'none';

                // Disable execute button
                if (executeBtn) {
                    executeBtn.disabled = true;
                }
            }
        }

        function startLiveSession() {
            if (!currentPlan || !currentPlan.scheduled_targets || currentPlan.scheduled_targets.length === 0) {
                alert('No plan available. Please create a plan in the Planner tab first, or load a saved plan.');
                return;
            }

            // Plan is already loaded, just highlight it
            updatePlanSelectionUI();

            // Scroll down to connection/execution area
            const connectionPanel = document.querySelector('.telescope-panel');
            if (connectionPanel) {
                connectionPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            alert('Plan is ready! Connect to your telescope and click "Execute Plan" to begin.');
        }

        function showLoadPlanModal() {
            const modal = document.getElementById('load-plan-modal');
            modal.style.display = 'block';

            // Reset states
            document.getElementById('load-plan-loading').style.display = 'block';
            document.getElementById('load-plan-empty').style.display = 'none';
            document.getElementById('load-plan-grid').style.display = 'none';

            // Load plans
            loadSavedPlans();
        }

        function closeLoadPlanModal() {
            document.getElementById('load-plan-modal').style.display = 'none';
        }

        async function loadSavedPlans() {
            try {
                const response = await fetch('/api/plans/');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const plans = await response.json();

                // Hide loading
                document.getElementById('load-plan-loading').style.display = 'none';

                if (!plans || plans.length === 0) {
                    // Show empty state
                    document.getElementById('load-plan-empty').style.display = 'block';
                    return;
                }

                // Show plans grid
                const grid = document.getElementById('load-plan-grid');
                grid.style.display = 'grid';
                grid.innerHTML = '';

                // Create plan cards
                plans.forEach(plan => {
                    const card = createSavedPlanCard(plan);
                    grid.appendChild(card);
                });

            } catch (error) {
                console.error('Error loading saved plans:', error);
                document.getElementById('load-plan-loading').style.display = 'none';
                document.getElementById('load-plan-empty').innerHTML = `
                    <h3 style="color: #dc3545;">Error Loading Plans</h3>
                    <p style="margin-top: 10px;">Unable to load saved plans: ${error.message}</p>
                    <button class="btn" style="margin-top: 20px; padding: 10px 20px;" onclick="closeLoadPlanModal();">
                        Close
                    </button>
                `;
                document.getElementById('load-plan-empty').style.display = 'block';
            }
        }

        function createSavedPlanCard(planData) {
            const card = document.createElement('div');
            card.className = 'saved-plan-card';

            // API returns summary objects directly, not nested with a plan key
            const targetCount = planData.total_targets || 0;
            const location = planData.location_name || 'Unknown';
            const createdAt = planData.created_at ? new Date(planData.created_at) : null;
            const dateStr = createdAt ? createdAt.toLocaleDateString() : 'Unknown';
            const timeStr = createdAt ? createdAt.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '';

            card.innerHTML = `
                <div class="saved-plan-name">${planData.name || 'Unnamed Plan'}</div>
                <div class="saved-plan-date">Created: ${dateStr} at ${timeStr}</div>
                ${planData.description ? `<div class="saved-plan-description">${planData.description}</div>` : ''}
                <div class="saved-plan-meta">
                    <span class="saved-plan-location">üìç ${location}</span>
                    <span class="saved-plan-targets">${targetCount} targets</span>
                </div>
                <div class="saved-plan-actions">
                    <button class="saved-plan-delete-btn" onclick="event.stopPropagation(); deletePlan(${planData.id})">Delete</button>
                    <button class="saved-plan-load-btn" onclick="event.stopPropagation(); selectSavedPlan(${planData.id})">Load Plan</button>
                </div>
            `;

            return card;
        }

        async function selectSavedPlan(planId) {
            try {
                const response = await fetch(`/api/plans/${planId}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const planData = await response.json();

                // Load the plan
                currentPlan = planData.plan;
                currentPlan.name = planData.name;
                currentPlan.description = planData.description;

                // Debug: Log the actual plan structure
                console.log('Full planData from API:', planData);
                console.log('currentPlan after assignment:', currentPlan);
                console.log('currentPlan keys:', Object.keys(currentPlan));

                // Close modal first (before switching tabs)
                closeLoadPlanModal();

                // Switch to planner tab to preview the loaded plan
                showTab('planner');

                // Make results div visible by adding 'active' class
                const resultsDiv = document.getElementById('results');
                console.log('Results div found:', resultsDiv !== null);
                if (resultsDiv) {
                    resultsDiv.classList.add('active');
                    console.log('Results div classList after adding active:', resultsDiv.classList.toString());
                    console.log('Results div display style:', window.getComputedStyle(resultsDiv).display);
                } else {
                    console.error('Results div not found!');
                }

                // Wait for tab to be fully rendered before displaying plan
                // This ensures DOM elements are visible and charts can render properly
                setTimeout(() => {
                    console.log('Calling displayPlan() with currentPlan');

                    // Display the plan
                    if (typeof displayPlan === 'function') {
                        displayPlan(currentPlan);
                    }

                    // Update UI
                    updatePlanSelectionUI();

                    // Scroll to the plan preview section
                    const sessionSummary = document.getElementById('session-summary');
                    if (sessionSummary) {
                        sessionSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }

                    // Show success notification
                    console.log(`Plan "${planData.name}" loaded successfully`);
                }, 100);

            } catch (error) {
                console.error('Error loading plan:', error);
                alert(`Error loading plan: ${error.message}`);
            }
        }

        async function deletePlan(planId) {
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/plans/${planId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Show success message
                console.log(`Plan ${planId} deleted successfully`);

                // Reload the plans list to refresh the UI
                loadSavedPlans();

            } catch (error) {
                console.error('Error deleting plan:', error);
                alert(`Error deleting plan: ${error.message}`);
            }
        }

        function goToPlanner() {
            showTab('planner');
        }

        // Refresh current conditions in Observe Tab
        async function refreshObserveConditions() {
            const contentDiv = document.getElementById('observe-conditions-content');
            contentDiv.innerHTML = '<div style="text-align: center; padding: 10px;">Loading...</div>';

            try {
                const latitude = parseFloat(document.getElementById('latitude').value);
                const longitude = parseFloat(document.getElementById('longitude').value);

                // Fetch sky quality and astronomy weather in parallel
                const [skyQualityResponse, astroWeatherResponse] = await Promise.all([
                    fetch(`/api/sky-quality/${latitude}/${longitude}`),
                    fetch(`/api/weather/astronomy?lat=${latitude}&lon=${longitude}&hours=3`)
                ]);

                let html = '';

                // Sky Quality
                if (skyQualityResponse.ok) {
                    const skyQuality = await skyQualityResponse.json();
                    const bortleColor = skyQuality.bortle_class <= 3 ? '#4ade80' :
                                       skyQuality.bortle_class <= 5 ? '#fbbf24' : '#ef4444';
                    html += `<div style="margin-bottom: 10px;">
                        <strong>Sky Quality</strong><br>
                        <span style="color: ${bortleColor};">Bortle ${skyQuality.bortle_class}</span> -
                        SQM ${skyQuality.sqm_estimate.toFixed(1)}
                    </div>`;
                }

                // Current Weather/Conditions
                if (astroWeatherResponse.ok) {
                    const astroWeather = await astroWeatherResponse.json();
                    if (astroWeather.forecast && astroWeather.forecast.length > 0) {
                        const current = astroWeather.forecast[0];
                        const scoreColor = (current.astronomy_score * 100) >= 70 ? '#4ade80' :
                                         (current.astronomy_score * 100) >= 40 ? '#fbbf24' : '#ef4444';

                        html += `<div>
                            <strong>Current Conditions</strong><br>
                            Quality: <span style="color: ${scoreColor};">${(current.astronomy_score * 100).toFixed(0)}%</span><br>
                            Clouds: ${current.cloud_cover.description}<br>
                            Transparency: ${current.transparency}<br>
                            Seeing: ${current.seeing}
                        </div>`;
                    }
                }

                if (html) {
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.6;">No data available</div>';
                }

            } catch (error) {
                console.error('Error fetching conditions:', error);
                contentDiv.innerHTML = '<div style="text-align: center; padding: 10px; color: #ef4444;">Error loading conditions</div>';
            }
        }

        // Close modals when clicking outside of them
        window.onclick = function(event) {
            const qrModal = document.getElementById('qr-modal');
            const previewModal = document.getElementById('preview-modal');
            const savePlanModal = document.getElementById('save-plan-modal');
            const loadPlanModal = document.getElementById('load-plan-modal');

            if (event.target === qrModal) {
                closeQRModal();
            }
            if (event.target === previewModal) {
                closePreviewModal();
            }
            if (event.target === savePlanModal) {
                closeSavePlanModal();
            }
            if (event.target === loadPlanModal) {
                closeLoadPlanModal();
            }
        }

        // ======================
        // Catalog Browser Functions
        // ======================

        let catalogFilters = {
            objectType: '',
            minMagnitude: null,
            maxMagnitude: null,
            constellation: '',
            searchQuery: '',
            page: 0,
            limit: 50,
            lastResults: []  // Store last results for add-to-plan functionality
        };

        // HTML escaping helper to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Custom Plan Builder State
        const customPlan = {
            targets: [],  // Array of catalog objects

            add(target) {
                // Don't add duplicates
                if (this.targets.find(t => t.catalog_id === target.catalog_id)) {
                    return false;
                }
                this.targets.push(target);
                this.save();
                this.render();
                return true;
            },

            remove(catalogId) {
                this.targets = this.targets.filter(t => t.catalog_id !== catalogId);
                this.save();
                this.render();
            },

            clear() {
                this.targets = [];
                this.save();
                this.render();
            },

            save() {
                try {
                    localStorage.setItem('astro_custom_plan', JSON.stringify(this.targets));
                } catch (e) {
                    console.warn('Could not save custom plan to localStorage:', e);
                }
            },

            load() {
                try {
                    const saved = localStorage.getItem('astro_custom_plan');
                    if (saved) {
                        this.targets = JSON.parse(saved);
                        this.render();
                    }
                } catch (e) {
                    console.warn('Could not load custom plan from localStorage:', e);
                    this.targets = [];
                }
            },

            render() {
                const container = document.getElementById('custom-plan-container');
                if (!container) return;

                if (this.targets.length === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';

                const chips = this.targets.map(t => `
                    <span class="plan-chip">
                        ${escapeHtml(t.name)} <button onclick="customPlan.remove('${escapeHtml(t.catalog_id)}')">&times;</button>
                    </span>
                `).join('');

                document.getElementById('plan-chips').innerHTML = chips;
                document.getElementById('plan-count').textContent = this.targets.length;
            },

            async generatePlan() {
                if (this.targets.length === 0) {
                    alert('Add objects to your plan first!');
                    return;
                }

                // Check if planner tab has existing plan
                const existingPlan = document.getElementById('session-summary');
                const hasExistingPlan = existingPlan && existingPlan.style.display !== 'none';

                if (hasExistingPlan) {
                    if (!confirm(`Replace existing plan?\n\nThis will replace the current plan in the Planner tab with a new plan optimized for these ${this.targets.length} objects.`)) {
                        return;
                    }
                }

                // TODO: Call /api/plan with custom targets
                // For now, just show message
                alert(`Generating plan for ${this.targets.length} objects...\n\nThis will be implemented in next task.`);

                // Clear custom plan
                this.clear();

                // Switch to planner tab
                showTab('planner');
            }
        };

        // Load saved plan on page load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => customPlan.load());
        } else {
            customPlan.load();
        }

        // Load catalog statistics
        async function loadCatalogStats() {
            try {
                const response = await fetch('/api/catalog/stats');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                catalogStats = await response.json();

                // Update stats display
                const statsGrid = document.getElementById('catalog-stats-grid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <span class="stat-value">${catalogStats.total_objects.toLocaleString()}</span>
                        <span class="stat-label">Total Objects</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${(catalogStats.by_type.galaxy || 0).toLocaleString()}</span>
                        <span class="stat-label">Galaxies</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${(catalogStats.by_type.cluster || 0).toLocaleString()}</span>
                        <span class="stat-label">Clusters</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${(catalogStats.by_type.nebula || 0).toLocaleString()}</span>
                        <span class="stat-label">Nebulae</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">${(catalogStats.by_type.planetary_nebula || 0).toLocaleString()}</span>
                        <span class="stat-label">Planetary Nebulae</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading catalog stats:', error);
            }
        }

        // Load catalog objects with filters
        async function loadCatalogObjects() {
            const loading = document.getElementById('catalog-loading');
            const results = document.getElementById('catalog-results');

            loading.classList.add('active');
            results.style.opacity = '0.5';

            try {
                let objects;

                // Check if filtering for comets or asteroids
                if (catalogFilters.objectType === 'comet') {
                    // Call comet API
                    const params = new URLSearchParams();
                    if (catalogFilters.maxMagnitude !== null && catalogFilters.maxMagnitude !== '') {
                        params.append('max_magnitude', catalogFilters.maxMagnitude);
                    }
                    params.append('limit', catalogFilters.limit);
                    params.append('offset', catalogFilters.page * catalogFilters.limit);

                    const response = await fetch(`/api/comets/?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    objects = await response.json();
                } else if (catalogFilters.objectType === 'asteroid') {
                    // Call asteroid API
                    const params = new URLSearchParams();
                    if (catalogFilters.maxMagnitude !== null && catalogFilters.maxMagnitude !== '') {
                        params.append('max_magnitude', catalogFilters.maxMagnitude);
                    }
                    params.append('limit', catalogFilters.limit);
                    params.append('offset', catalogFilters.page * catalogFilters.limit);

                    const response = await fetch(`/api/asteroids/?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    objects = await response.json();
                } else if (catalogFilters.objectType === 'planet') {
                    // Call planet API (simple, no pagination needed - only 8 planets)
                    const response = await fetch('/api/planets/');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    objects = await response.json();
                } else {
                    // Original DSO API call
                    const params = new URLSearchParams();

                    if (catalogFilters.objectType) {
                        params.append('object_types', catalogFilters.objectType);
                    }
                    if (catalogFilters.minMagnitude !== null && catalogFilters.minMagnitude !== '') {
                        params.append('min_magnitude', catalogFilters.minMagnitude);
                    }
                    if (catalogFilters.maxMagnitude !== null && catalogFilters.maxMagnitude !== '') {
                        params.append('max_magnitude', catalogFilters.maxMagnitude);
                    }
                    if (catalogFilters.constellation) {
                        params.append('constellation', catalogFilters.constellation);
                    }
                    params.append('limit', catalogFilters.limit);
                    params.append('offset', catalogFilters.page * catalogFilters.limit);

                    const response = await fetch(`/api/targets?${params.toString()}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    objects = await response.json();
                }

                displayCatalogObjects(objects);

                loading.classList.remove('active');
                results.style.opacity = '1';

            } catch (error) {
                console.error('Error loading catalog objects:', error);
                loading.classList.remove('active');
                results.style.opacity = '1';

                const grid = document.getElementById('catalog-grid');
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>Error Loading Catalog</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Display catalog objects
        function displayCatalogObjects(objects) {
            // Store for add-to-plan functionality
            catalogFilters.lastResults = objects;

            const grid = document.getElementById('catalog-grid');
            const resultsCount = document.getElementById('catalog-results-count');
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');

            if (objects.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No Objects Found</h3>
                        <p>Try adjusting your filters or search terms.</p>
                    </div>
                `;
                resultsCount.textContent = 'No objects found';
                nextBtn.disabled = true;
                return;
            }

            resultsCount.textContent = `Showing ${catalogFilters.page * catalogFilters.limit + 1}-${catalogFilters.page * catalogFilters.limit + objects.length} objects`;
            pageInfo.textContent = `Page ${catalogFilters.page + 1}`;
            prevBtn.disabled = catalogFilters.page === 0;
            nextBtn.disabled = objects.length < catalogFilters.limit;

            grid.innerHTML = objects.map(obj => {
                // Check object type: comets have comet_type, asteroids have asteroid_type/number, planets have planet_type, DSOs have catalog_id
                const isComet = obj.comet_type !== undefined;
                const isAsteroid = obj.asteroid_type !== undefined || (obj.number !== undefined && obj.designation !== undefined);
                const isPlanet = obj.planet_type !== undefined;

                if (isComet) {
                    // Comet display
                    const magStr = obj.current_magnitude && obj.current_magnitude < 99 ? obj.current_magnitude.toFixed(1) : 'N/A';
                    const eccStr = obj.orbital_elements?.eccentricity ? obj.orbital_elements.eccentricity.toFixed(3) : 'N/A';
                    const periStr = obj.orbital_elements?.perihelion_distance_au ? obj.orbital_elements.perihelion_distance_au.toFixed(2) + ' AU' : 'N/A';

                    return `
                        <div class="catalog-item">
                            <div class="catalog-item-header">
                                <div class="catalog-item-name">${obj.name || obj.designation}</div>
                                <div class="catalog-item-type">${obj.comet_type || 'comet'}</div>
                            </div>
                            <div class="catalog-item-details">
                                <div><strong>Designation:</strong> ${obj.designation}</div>
                                <div><strong>Magnitude:</strong> ${magStr}</div>
                                <div><strong>Activity:</strong> ${obj.activity_status || 'unknown'}</div>
                                <div><strong>Eccentricity:</strong> ${eccStr}</div>
                                <div><strong>Perihelion:</strong> ${periStr}</div>
                                ${obj.notes ? `<div style="margin-top: 8px; font-style: italic;">${obj.notes}</div>` : ''}
                            </div>
                            <div class="catalog-item-actions">
                                <button class="select-btn" onclick="event.stopPropagation(); selectCatalogObject('${obj.designation}')">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </div>
                        </div>
                    `;
                } else if (isAsteroid) {
                    // Asteroid display
                    const magStr = obj.current_magnitude && obj.current_magnitude < 99 ? obj.current_magnitude.toFixed(1) : 'N/A';
                    const semiMajorStr = obj.orbital_elements?.semi_major_axis_au ? obj.orbital_elements.semi_major_axis_au.toFixed(2) + ' AU' : 'N/A';
                    const eccStr = obj.orbital_elements?.eccentricity ? obj.orbital_elements.eccentricity.toFixed(3) : 'N/A';
                    const diameterStr = obj.diameter_km ? obj.diameter_km.toFixed(1) + ' km' : 'N/A';
                    const displayName = obj.name ? `${obj.name} (${obj.designation})` : obj.designation;
                    const numberStr = obj.number ? `${obj.number}` : '';

                    return `
                        <div class="catalog-item">
                            <div class="catalog-item-header">
                                <div class="catalog-item-name">${displayName}</div>
                                <div class="catalog-item-type">${obj.asteroid_type || 'asteroid'}</div>
                            </div>
                            <div class="catalog-item-details">
                                ${numberStr ? `<div><strong>Number:</strong> ${numberStr}</div>` : ''}
                                <div><strong>Designation:</strong> ${obj.designation}</div>
                                <div><strong>Magnitude:</strong> ${magStr}</div>
                                <div><strong>Diameter:</strong> ${diameterStr}</div>
                                <div><strong>Semi-major axis:</strong> ${semiMajorStr}</div>
                                <div><strong>Eccentricity:</strong> ${eccStr}</div>
                                ${obj.spectral_type ? `<div><strong>Spectral Type:</strong> ${obj.spectral_type}</div>` : ''}
                                ${obj.notes ? `<div style="margin-top: 8px; font-style: italic;">${obj.notes}</div>` : ''}
                            </div>
                            <div class="catalog-item-actions">
                                <button class="select-btn" onclick="event.stopPropagation(); selectCatalogObject('${obj.designation}')">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </div>
                        </div>
                    `;
                } else if (isPlanet) {
                    // Planet display
                    const diameterStr = obj.diameter_km ? obj.diameter_km.toFixed(0) + ' km' : 'N/A';
                    const orbitalPeriodStr = obj.orbital_period_days ? (obj.orbital_period_days / 365.25).toFixed(2) + ' years' : 'N/A';
                    const rotationStr = obj.rotation_period_hours ? obj.rotation_period_hours.toFixed(1) + ' hours' : 'N/A';
                    const moonsStr = obj.num_moons > 0 ? obj.num_moons : 'None';
                    const ringsStr = obj.has_rings ? 'Yes' : 'No';

                    // Special styling for Sun with safety warning
                    const isSun = obj.name === 'Sun';
                    const sunWarningStyle = isSun ? 'border-left: 3px solid #f57c00;' : '';
                    const sunWarning = isSun ? `<div class="input-hint" style="margin-top: 8px; color: #e65100;">‚ö†Ô∏è Requires proper solar filter</div>` : '';

                    return `
                        <div class="catalog-item" style="${sunWarningStyle}">
                            <div class="catalog-item-header">
                                <div class="catalog-item-name">${obj.name}</div>
                                <div class="catalog-item-type">${obj.planet_type}</div>
                            </div>
                            <div class="catalog-item-details">
                                <div><strong>Diameter:</strong> ${diameterStr}</div>
                                <div><strong>Orbital Period:</strong> ${orbitalPeriodStr}</div>
                                <div><strong>Rotation Period:</strong> ${rotationStr}</div>
                                <div><strong>Moons:</strong> ${moonsStr}</div>
                                <div><strong>Rings:</strong> ${ringsStr}</div>
                                ${obj.notes ? `<div style="margin-top: 8px; font-style: italic;">${obj.notes}</div>` : ''}
                                ${sunWarning}
                            </div>
                            <div class="catalog-item-actions">
                                <button class="select-btn" onclick="event.stopPropagation(); selectCatalogObject('${obj.name}')">
                                    ‚ÑπÔ∏è Details
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // DSO display with visibility
                    const magStr = obj.magnitude && obj.magnitude < 99 ? obj.magnitude.toFixed(1) : 'N/A';
                    const sizeStr = obj.size_arcmin ? `${obj.size_arcmin.toFixed(1)}'` : 'N/A';
                    const raStr = obj.ra_hours ? `${obj.ra_hours.toFixed(2)}h` : 'N/A';
                    const decStr = obj.dec_degrees ? `${obj.dec_degrees >= 0 ? '+' : ''}${obj.dec_degrees.toFixed(2)}¬∞` : 'N/A';

                    // Convert RA hours to degrees for image services
                    const raDeg = obj.ra_hours ? (obj.ra_hours * 15).toFixed(4) : null;

                    // Auto-generate preview image URL
                    const sanitizedId = obj.catalog_id.replace(/ /g, '_').replace(/\//g, '_').replace(/:/g, '_');
                    const previewImageUrl = `/api/images/targets/${sanitizedId}`;

                    // Visibility badge and info
                    let visibilityBadge = '';
                    let visibilityInfo = '';

                    if (obj.visibility) {
                        const vis = obj.visibility;
                        const badgeColors = {
                            visible: '#28a745',
                            rising: '#007bff',
                            setting: '#fd7e14',
                            below_horizon: '#6c757d'
                        };
                        const badgeLabels = {
                            visible: 'üü¢ Visible',
                            rising: 'üîµ Rising',
                            setting: 'üü† Setting',
                            below_horizon: '‚ö´ Below'
                        };

                        visibilityBadge = `<span class="visibility-badge" style="background: ${badgeColors[vis.status]}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8em;">${badgeLabels[vis.status]}</span>`;

                        const altTrend = vis.status === 'rising' ? '‚Üó' : vis.status === 'setting' ? '‚Üò' : '';
                        const bestTime = vis.best_time_tonight ? new Date(vis.best_time_tonight).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'}) : 'N/A';
                        const bestAlt = vis.best_altitude_tonight ? vis.best_altitude_tonight.toFixed(0) + '¬∞' : 'N/A';

                        visibilityInfo = `
                            <div class="visibility-info" style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                                <div style="font-size: 0.9em; color: #666; line-height: 1.8;">
                                    <div>üìç Alt now: ${vis.current_altitude.toFixed(0)}¬∞ ${altTrend}</div>
                                    <div>‚≠ê Best: ${bestTime} at ${bestAlt}</div>
                                    <div>üìÖ Best months: ${getBestMonths(obj.ra_hours)}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // No location configured
                        visibilityInfo = `
                            <div class="visibility-info" style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                                <div style="font-size: 0.9em; color: #666; line-height: 1.8;">
                                    <div>üìç <a href="#" onclick="event.preventDefault(); showTab('settings'); return false;" style="color: #667eea;">Set location</a> to see visibility</div>
                                    <div>üìÖ Best months: ${getBestMonths(obj.ra_hours)}</div>
                                </div>
                            </div>
                        `;
                    }

                    // Check if already in plan
                    const inPlan = customPlan.targets.find(t => t.catalog_id === obj.catalog_id);
                    const addButtonHtml = inPlan
                        ? '<button class="select-btn" disabled style="background: #28a745; color: white;">‚úì Added</button>'
                        : `<button class="select-btn" onclick="event.stopPropagation(); addToPlan('${obj.catalog_id}')" style="background: #667eea; color: white;">‚ûï Add to Plan</button>`;

                    return `
                        <div class="catalog-item">
                            <div class="catalog-item-header">
                                <div class="catalog-item-name">${obj.name}</div>
                                ${visibilityBadge || `<div class="catalog-item-type">${obj.object_type}</div>`}
                            </div>
                            <div style="margin-bottom: 12px;">
                                <img src="${previewImageUrl}"
                                     alt="${obj.name} preview"
                                     style="width: 100%; max-width: 250px; height: auto; border-radius: 6px; border: 2px solid #e0e0e0; cursor: pointer; display: block; margin: 0 auto;"
                                     onclick="event.stopPropagation(); showObjectPreview('${obj.name}', '${obj.catalog_id}', ${raDeg}, ${obj.dec_degrees}, ${obj.size_arcmin || 60})"
                                     onerror="this.style.display='none'">
                            </div>
                            <div class="catalog-item-details">
                                <div><strong>Type:</strong> ${obj.object_type}</div>
                                <div><strong>Magnitude:</strong> ${magStr} ‚Ä¢ <strong>Size:</strong> ${sizeStr}</div>
                                <div><strong>RA/Dec:</strong> ${raStr}, ${decStr}</div>
                            </div>
                            ${visibilityInfo}
                            <div class="catalog-item-actions" style="display: flex; gap: 8px; margin-top: 12px;">
                                ${raDeg && obj.dec_degrees ? `
                                    <button class="preview-btn" onclick="event.stopPropagation(); showObjectPreview('${obj.name}', '${obj.catalog_id}', ${raDeg}, ${obj.dec_degrees}, ${obj.size_arcmin || 60})">
                                        üî≠ Preview
                                    </button>
                                ` : ''}
                                ${addButtonHtml}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Helper: Get best viewing months from RA
        function getBestMonths(raHours) {
            if (!raHours) return 'N/A';

            // Convert RA to month (opposition month when object is highest at midnight)
            // RA 0h ‚Üí September/October (opposite of March sun)
            // RA 6h ‚Üí December/January
            // RA 12h ‚Üí March/April
            // RA 18h ‚Üí June/July

            const monthStart = Math.floor((raHours + 6) / 2) % 12;
            const monthEnd = (monthStart + 2) % 12;

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

            return `${months[monthStart]}-${months[monthEnd]}`;
        }

        // Add target to custom plan
        function addToPlan(catalogId) {
            const target = catalogFilters.lastResults.find(t => t.catalog_id === catalogId);
            if (!target) {
                alert('Could not find target');
                return;
            }

            if (customPlan.add(target)) {
                // Refresh catalog display to update button state
                displayCatalogObjects(catalogFilters.lastResults);
            }
        }

        // Select catalog object (placeholder for future functionality)
        function selectCatalogObject(catalogId) {
            alert(`Selected: ${catalogId}\n\nFuture enhancement: This will show detailed object information and allow adding to a custom observing plan.`);
        }

        // Show viewing months for an object
        async function showViewingMonths(objectName, raHours, decDegrees) {
            try {
                const latitude = parseFloat(document.getElementById('latitude').value);

                const response = await fetch(`/api/viewing-months?ra_hours=${raHours}&dec_degrees=${decDegrees}&latitude=${latitude}&object_name=${encodeURIComponent(objectName)}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Get best 3 months
                const bestMonths = data.months
                    .filter(m => m.is_good_month)
                    .sort((a, b) => b.rating_value - a.rating_value)
                    .slice(0, 3);

                let monthsHtml = '<div style="margin-top: 10px;">';

                if (bestMonths.length > 0) {
                    monthsHtml += '<strong>Best Viewing Months:</strong><br>';
                    bestMonths.forEach(month => {
                        const ratingColor = month.rating_value >= 5 ? '#4ade80' :
                                          month.rating_value >= 4 ? '#10b981' : '#fbbf24';
                        monthsHtml += `<div style="margin: 5px 0;">
                            <span style="color: ${ratingColor}; font-weight: bold;">${month.month_name}</span> -
                            ${month.rating} (${month.visibility_hours.toFixed(1)}h visible, best at ${month.best_time})
                        </div>`;
                    });
                } else {
                    monthsHtml += '<p>Object has limited visibility from your latitude.</p>';
                }

                monthsHtml += '</div>';

                alert(`üìÖ Best Viewing Months for ${objectName}\n\n` +
                      bestMonths.map(m => `${m.month_name}: ${m.rating} (${m.visibility_hours.toFixed(1)}h, best at ${m.best_time})`).join('\n') +
                      `\n\nFrom latitude: ${latitude}¬∞`);

            } catch (error) {
                console.error('Error fetching viewing months:', error);
                alert(`Error loading viewing months: ${error.message}`);
            }
        }

        // Apply catalog filters
        function applyCatalogFilters() {
            catalogFilters.objectType = document.getElementById('filter-object-type').value;
            catalogFilters.minMagnitude = document.getElementById('filter-min-magnitude').value;
            catalogFilters.maxMagnitude = document.getElementById('filter-max-magnitude').value;
            catalogFilters.constellation = document.getElementById('filter-constellation').value.trim();
            catalogFilters.page = 0;

            updateActiveFilters();
            loadCatalogObjects();
        }

        // Clear catalog filters
        function clearCatalogFilters() {
            document.getElementById('filter-object-type').value = '';
            document.getElementById('filter-min-magnitude').value = '';
            document.getElementById('filter-max-magnitude').value = '';
            document.getElementById('filter-constellation').value = '';
            document.getElementById('catalog-search').value = '';

            catalogFilters.objectType = '';
            catalogFilters.minMagnitude = null;
            catalogFilters.maxMagnitude = null;
            catalogFilters.constellation = '';
            catalogFilters.searchQuery = '';
            catalogFilters.page = 0;

            updateActiveFilters();
            loadCatalogObjects();
        }

        // Update active filters display
        function updateActiveFilters() {
            const filterTags = document.getElementById('active-filters');
            const tags = [];

            if (catalogFilters.objectType) {
                tags.push({ label: `Type: ${catalogFilters.objectType}`, field: 'objectType' });
            }
            if (catalogFilters.minMagnitude !== null && catalogFilters.minMagnitude !== '') {
                tags.push({ label: `Min Mag: ${catalogFilters.minMagnitude}`, field: 'minMagnitude' });
            }
            if (catalogFilters.maxMagnitude !== null && catalogFilters.maxMagnitude !== '') {
                tags.push({ label: `Max Mag: ${catalogFilters.maxMagnitude}`, field: 'maxMagnitude' });
            }
            if (catalogFilters.constellation) {
                tags.push({ label: `Constellation: ${catalogFilters.constellation}`, field: 'constellation' });
            }
            if (catalogFilters.searchQuery) {
                tags.push({ label: `Search: ${catalogFilters.searchQuery}`, field: 'searchQuery' });
            }

            if (tags.length === 0) {
                filterTags.innerHTML = '<p style="color: #999; font-size: 0.9em;">No active filters</p>';
            } else {
                filterTags.innerHTML = tags.map(tag => `
                    <div class="filter-tag">
                        ${tag.label}
                        <button onclick="removeFilter('${tag.field}')" title="Remove filter">√ó</button>
                    </div>
                `).join('');
            }
        }

        // Remove specific filter
        function removeFilter(field) {
            switch (field) {
                case 'objectType':
                    catalogFilters.objectType = '';
                    document.getElementById('filter-object-type').value = '';
                    break;
                case 'minMagnitude':
                    catalogFilters.minMagnitude = null;
                    document.getElementById('filter-min-magnitude').value = '';
                    break;
                case 'maxMagnitude':
                    catalogFilters.maxMagnitude = null;
                    document.getElementById('filter-max-magnitude').value = '';
                    break;
                case 'constellation':
                    catalogFilters.constellation = '';
                    document.getElementById('filter-constellation').value = '';
                    break;
                case 'searchQuery':
                    catalogFilters.searchQuery = '';
                    document.getElementById('catalog-search').value = '';
                    break;
            }

            catalogFilters.page = 0;
            updateActiveFilters();
            loadCatalogObjects();
        }

        // Search catalog
        function searchCatalog() {
            const searchInput = document.getElementById('catalog-search');
            const searchQuery = searchInput.value.trim();

            if (!searchQuery) {
                alert('Please enter a search term');
                return;
            }

            catalogFilters.searchQuery = searchQuery;
            catalogFilters.page = 0;

            // For now, search by catalog ID directly
            // Future: implement full-text search on backend
            searchByCatalogId(searchQuery);
        }

        // Search by catalog ID
        async function searchByCatalogId(catalogId) {
            const loading = document.getElementById('catalog-loading');
            const results = document.getElementById('catalog-results');

            loading.classList.add('active');
            results.style.opacity = '0.5';

            try {
                const response = await fetch(`/api/targets/${catalogId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        alert(`Object not found: ${catalogId}\n\nTry searching for Messier (M31), NGC (NGC7000), or IC (IC405) objects.`);
                        loading.classList.remove('active');
                        results.style.opacity = '1';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const object = await response.json();
                displayCatalogObjects([object]);

                loading.classList.remove('active');
                results.style.opacity = '1';

            } catch (error) {
                console.error('Error searching catalog:', error);
                loading.classList.remove('active');
                results.style.opacity = '1';
                alert(`Error searching catalog: ${error.message}`);
            }
        }

        // Pagination
        function previousPage() {
            if (catalogFilters.page > 0) {
                catalogFilters.page--;
                loadCatalogObjects();
            }
        }

        function nextPage() {
            catalogFilters.page++;
            loadCatalogObjects();
        }

        // Handle Enter key in search box
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('catalog-search');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchCatalog();
                    }
                });
            }
        });

        // ========================================================================
        // Telescope Control Functions
        // ========================================================================

        let telescopeConnected = false;
        let progressCheckInterval = null;
        // currentPlan is already declared globally at line 1445

        async function connectTelescope() {
            const host = document.getElementById('telescope-host').value;
            const connectBtn = document.getElementById('connect-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');

            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';

            try {
                const response = await fetch('/api/telescope/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({host: host, port: 4700})
                });

                const data = await response.json();

                if (response.ok) {
                    telescopeConnected = true;
                    statusIndicator.className = 'status-indicator status-connected';
                    connectionStatus.textContent = 'Connected';
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.onclick = disconnectTelescope;

                    // Show firmware version
                    if (data.firmware_version) {
                        document.getElementById('firmware-version').textContent =
                            `Firmware: ${data.firmware_version}`;
                    }

                    // Enable execution buttons
                    document.getElementById('execute-btn').disabled = false;
                    document.getElementById('park-btn').disabled = false;

                    alert('‚úÖ Connected to Seestar S50!');
                } else {
                    throw new Error(data.detail || 'Connection failed');
                }
            } catch (error) {
                alert('‚ùå Connection failed: ' + error.message);
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
            } finally {
                connectBtn.disabled = false;
            }
        }

        async function disconnectTelescope() {
            const connectBtn = document.getElementById('connect-btn');
            const statusIndicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');

            try {
                await fetch('/api/telescope/disconnect', {method: 'POST'});

                telescopeConnected = false;
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = connectTelescope;

                // Disable execution buttons
                document.getElementById('execute-btn').disabled = true;
                document.getElementById('abort-btn').disabled = true;
                document.getElementById('park-btn').disabled = true;

                // Stop progress monitoring
                if (progressCheckInterval) {
                    clearInterval(progressCheckInterval);
                    progressCheckInterval = null;
                }

            } catch (error) {
                alert('Error disconnecting: ' + error.message);
            }
        }

        async function executePlan() {
            if (!currentPlan || !currentPlan.scheduled_targets) {
                alert('No plan available to execute. Generate a plan first.');
                return;
            }

            if (!confirm(`Execute observation plan with ${currentPlan.scheduled_targets.length} targets?`)) {
                return;
            }

            // Get park when done setting
            const parkWhenDone = document.getElementById('park-when-done').checked;

            try {
                const response = await fetch('/api/telescope/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        scheduled_targets: currentPlan.scheduled_targets,
                        park_when_done: parkWhenDone
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show progress panel
                    document.getElementById('progress-panel').style.display = 'block';

                    // Update button states
                    document.getElementById('execute-btn').disabled = true;
                    document.getElementById('abort-btn').disabled = false;
                    document.getElementById('connect-btn').disabled = true;

                    // Start monitoring progress
                    startProgressMonitoring();

                    alert('‚úÖ Execution started!');
                } else {
                    throw new Error(data.detail || 'Execution failed');
                }
            } catch (error) {
                alert('‚ùå Failed to start execution: ' + error.message);
            }
        }

        async function abortExecution() {
            if (!confirm('Abort the current execution?')) {
                return;
            }

            try {
                const response = await fetch('/api/telescope/abort', {method: 'POST'});
                const data = await response.json();

                if (response.ok) {
                    alert('‚èπÔ∏è Execution aborted');
                    stopProgressMonitoring();
                } else {
                    throw new Error(data.detail || 'Abort failed');
                }
            } catch (error) {
                alert('‚ùå Failed to abort: ' + error.message);
            }
        }

        async function parkTelescope() {
            if (!confirm('Park the telescope at home position?')) {
                return;
            }

            try {
                const response = await fetch('/api/telescope/park', {method: 'POST'});
                const data = await response.json();

                if (response.ok) {
                    alert('üè† Telescope parking...');
                } else {
                    throw new Error(data.detail || 'Park failed');
                }
            } catch (error) {
                alert('‚ùå Failed to park: ' + error.message);
            }
        }

        function startProgressMonitoring() {
            // Update progress every 2 seconds
            progressCheckInterval = setInterval(updateProgress, 2000);
            updateProgress();  // Update immediately
        }

        function stopProgressMonitoring() {
            if (progressCheckInterval) {
                clearInterval(progressCheckInterval);
                progressCheckInterval = null;
            }

            // Reset button states
            document.getElementById('execute-btn').disabled = false;
            document.getElementById('abort-btn').disabled = true;
            document.getElementById('connect-btn').disabled = false;
        }

        async function updateProgress() {
            try {
                const response = await fetch('/api/telescope/progress');
                const data = await response.json();

                if (!data.state) return;

                // Update current target
                document.getElementById('current-target').textContent =
                    data.current_target_name || '-';

                // Update phase
                document.getElementById('current-phase').textContent =
                    data.current_phase || '-';

                // Update completed count
                document.getElementById('targets-completed').textContent =
                    `${data.targets_completed || 0} / ${data.total_targets || 0}`;

                // Update elapsed time
                document.getElementById('elapsed-time').textContent =
                    data.elapsed_time || '-';

                // Update progress bar
                const progress = data.progress_percent || 0;
                const progressBar = document.getElementById('progress-bar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;

                // Update errors if any
                if (data.errors && data.errors.length > 0) {
                    const errorPanel = document.getElementById('error-panel');
                    const errorList = document.getElementById('error-list');
                    errorPanel.style.display = 'block';

                    errorList.innerHTML = data.errors.map(err => `
                        <div class="error-item">
                            <strong>${err.target}</strong> (${err.phase}): ${err.message}
                            ${err.retries > 0 ? ` [Retries: ${err.retries}]` : ''}
                        </div>
                    `).join('');
                }

                // Check if execution is finished
                if (data.state === 'completed' || data.state === 'aborted' || data.state === 'error') {
                    stopProgressMonitoring();

                    if (data.state === 'completed') {
                        alert(`‚úÖ Execution completed!\n\nCompleted: ${data.targets_completed}\nFailed: ${data.targets_failed}`);
                    } else if (data.state === 'aborted') {
                        alert('‚èπÔ∏è Execution was aborted');
                    } else {
                        alert('‚ùå Execution error occurred');
                    }
                }

            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        // ========================================================================
        // Main Observe Tab Functions (wrappers for standalone tab)
        // ========================================================================

        async function connectTelescopeMain() {
            const host = document.getElementById('telescope-host-main').value;
            const connectBtn = document.getElementById('connect-btn-main');
            const statusIndicator = document.getElementById('status-indicator-main');
            const connectionStatus = document.getElementById('connection-status-main');

            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';

            try {
                const response = await fetch('/api/telescope/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({host: host, port: 4700})
                });

                const data = await response.json();

                if (response.ok) {
                    telescopeConnected = true;
                    statusIndicator.className = 'status-indicator status-connected';
                    connectionStatus.textContent = 'Connected';
                    connectBtn.textContent = 'Disconnect';
                    connectBtn.onclick = disconnectTelescopeMain;

                    if (data.firmware_version) {
                        document.getElementById('firmware-version-main').textContent =
                            `Firmware: ${data.firmware_version}`;
                    }

                    document.getElementById('execute-btn-main').disabled = false;
                    document.getElementById('park-btn-main').disabled = false;

                    // Also update the planner tab controls if they exist
                    syncConnectionStatus(true, data.firmware_version);

                    alert('‚úÖ Connected to Seestar S50!');
                } else {
                    throw new Error(data.detail || 'Connection failed');
                }
            } catch (error) {
                alert('‚ùå Connection failed: ' + error.message);
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
            } finally {
                connectBtn.disabled = false;
            }
        }

        async function disconnectTelescopeMain() {
            const connectBtn = document.getElementById('connect-btn-main');
            const statusIndicator = document.getElementById('status-indicator-main');
            const connectionStatus = document.getElementById('connection-status-main');

            try {
                await fetch('/api/telescope/disconnect', {method: 'POST'});

                telescopeConnected = false;
                statusIndicator.className = 'status-indicator status-disconnected';
                connectionStatus.textContent = 'Disconnected';
                connectBtn.textContent = 'Connect';
                connectBtn.onclick = connectTelescopeMain;

                document.getElementById('execute-btn-main').disabled = true;
                document.getElementById('abort-btn-main').disabled = true;
                document.getElementById('park-btn-main').disabled = true;

                if (progressCheckInterval) {
                    clearInterval(progressCheckInterval);
                    progressCheckInterval = null;
                }

                syncConnectionStatus(false, null);

            } catch (error) {
                alert('Error disconnecting: ' + error.message);
            }
        }

        async function executePlanMain() {
            if (!currentPlan || !currentPlan.scheduled_targets) {
                alert('No plan available to execute.\n\nPlease go to the Planner tab and generate a plan first.');
                return;
            }

            if (!confirm(`Execute observation plan with ${currentPlan.scheduled_targets.length} targets?`)) {
                return;
            }

            // Get park when done setting
            const parkWhenDone = document.getElementById('park-when-done').checked;

            try {
                const response = await fetch('/api/telescope/execute', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        scheduled_targets: currentPlan.scheduled_targets,
                        park_when_done: parkWhenDone
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show execution status banner
                    document.getElementById('execution-status-banner').style.display = 'block';
                    document.getElementById('progress-panel-main').style.display = 'block';
                    document.getElementById('status-info-panel').style.display = 'none';

                    document.getElementById('execute-btn-main').disabled = true;
                    document.getElementById('abort-btn-main').disabled = false;
                    document.getElementById('connect-btn-main').disabled = true;

                    startProgressMonitoringMain();

                    alert('‚úÖ Execution started!');
                } else {
                    throw new Error(data.detail || 'Execution failed');
                }
            } catch (error) {
                alert('‚ùå Failed to start execution: ' + error.message);
            }
        }

        async function abortExecutionMain() {
            if (!confirm('Abort the current execution?')) {
                return;
            }

            try {
                const response = await fetch('/api/telescope/abort', {method: 'POST'});
                const data = await response.json();

                if (response.ok) {
                    alert('‚èπÔ∏è Execution aborted');
                    stopProgressMonitoringMain();
                } else {
                    throw new Error(data.detail || 'Abort failed');
                }
            } catch (error) {
                alert('‚ùå Failed to abort: ' + error.message);
            }
        }

        async function parkTelescopeMain() {
            if (!confirm('Park the telescope at home position?')) {
                return;
            }

            try {
                const response = await fetch('/api/telescope/park', {method: 'POST'});
                const data = await response.json();

                if (response.ok) {
                    alert('üè† Telescope parking...');
                } else {
                    throw new Error(data.detail || 'Park failed');
                }
            } catch (error) {
                alert('‚ùå Failed to park: ' + error.message);
            }
        }

        function startProgressMonitoringMain() {
            progressCheckInterval = setInterval(updateProgressMain, 2000);
            updateProgressMain();
        }

        function stopProgressMonitoringMain() {
            if (progressCheckInterval) {
                clearInterval(progressCheckInterval);
                progressCheckInterval = null;
            }

            document.getElementById('execute-btn-main').disabled = false;
            document.getElementById('abort-btn-main').disabled = true;
            document.getElementById('connect-btn-main').disabled = false;
        }

        // Toggle live view embed section
        function toggleLiveViewEmbed() {
            const container = document.getElementById('liveview-embed-container');
            const icon = document.getElementById('liveview-toggle-icon');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '‚ñ≤';
                icon.style.transform = 'rotate(180deg)';
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñº';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        async function updateProgressMain() {
            try {
                const response = await fetch('/api/telescope/progress');
                const data = await response.json();

                if (!data.state) return;

                // Update execution status banner
                const stateText = document.getElementById('execution-state-text');
                const statusDetail = document.getElementById('execution-status-detail');
                const progressNumber = document.getElementById('execution-progress-number');
                const timeDisplay = document.getElementById('execution-time-display');

                // Map state to display text
                const stateDisplayText = {
                    'starting': 'STARTING EXECUTION',
                    'running': 'EXECUTING PLAN',
                    'paused': 'EXECUTION PAUSED',
                    'stopping': 'STOPPING',
                    'completed': 'PLAN COMPLETED',
                    'aborted': 'EXECUTION ABORTED',
                    'error': 'EXECUTION ERROR'
                };

                stateText.textContent = stateDisplayText[data.state] || 'EXECUTING PLAN';

                // Build detailed status message
                let detailText = '';
                if (data.current_target_name && data.current_phase) {
                    detailText = `${data.current_target_name} - ${data.current_phase}`;
                } else if (data.current_target_name) {
                    detailText = data.current_target_name;
                } else if (data.current_phase) {
                    detailText = data.current_phase;
                } else {
                    detailText = 'Preparing...';
                }

                if (data.targets_completed !== undefined && data.total_targets) {
                    detailText += ` (${data.targets_completed}/${data.total_targets} targets)`;
                }

                statusDetail.textContent = detailText;
                progressNumber.textContent = `${Math.round(data.progress_percent || 0)}%`;
                timeDisplay.textContent = data.elapsed_time || '00:00';

                // Update target summary (new fields for redesigned banner)
                if (data.current_target_index !== undefined && data.total_targets) {
                    document.getElementById('execution-target-number').textContent = data.current_target_index + 1;
                    document.getElementById('execution-total-targets').textContent = data.total_targets;
                }

                // Update main tab progress
                document.getElementById('current-target-main').textContent = data.current_target_name || '-';
                document.getElementById('current-phase-main').textContent = data.current_phase || '-';
                document.getElementById('targets-completed-main').textContent =
                    `${data.targets_completed || 0} / ${data.total_targets || 0}`;
                document.getElementById('elapsed-time-main').textContent = data.elapsed_time || '-';
                document.getElementById('estimated-remaining-main').textContent = data.estimated_remaining || '-';

                const progress = data.progress_percent || 0;
                const progressBar = document.getElementById('progress-bar-main');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;

                // Also update planner tab if it exists
                updatePlannerProgress(data);

                if (data.errors && data.errors.length > 0) {
                    const errorPanel = document.getElementById('error-panel-main');
                    const errorList = document.getElementById('error-list-main');
                    errorPanel.style.display = 'block';

                    errorList.innerHTML = data.errors.map(err => `
                        <div class="error-item">
                            <strong>${err.target}</strong> (${err.phase}): ${err.message}
                            ${err.retries > 0 ? ` [Retries: ${err.retries}]` : ''}
                        </div>
                    `).join('');
                }

                if (data.state === 'completed' || data.state === 'aborted' || data.state === 'error') {
                    stopProgressMonitoringMain();

                    // Hide execution banner after a brief delay
                    setTimeout(() => {
                        document.getElementById('execution-status-banner').style.display = 'none';
                        document.getElementById('status-info-panel').style.display = 'block';
                    }, 3000);

                    if (data.state === 'completed') {
                        alert(`‚úÖ Execution completed!\n\nCompleted: ${data.targets_completed}\nFailed: ${data.targets_failed}`);
                    } else if (data.state === 'aborted') {
                        alert('‚èπÔ∏è Execution was aborted');
                    } else {
                        alert('‚ùå Execution error occurred');
                    }
                }

            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        // Helper function to sync connection status between tabs
        function syncConnectionStatus(connected, firmwareVersion) {
            const elements = ['connect-btn', 'status-indicator', 'connection-status', 'firmware-version'];
            const suffix = '';

            elements.forEach(base => {
                const elem = document.getElementById(base + suffix);
                if (!elem) return;

                if (base === 'connect-btn') {
                    elem.textContent = connected ? 'Disconnect' : 'Connect';
                    elem.onclick = connected ? disconnectTelescope : connectTelescope;
                } else if (base === 'status-indicator') {
                    elem.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
                } else if (base === 'connection-status') {
                    elem.textContent = connected ? 'Connected' : 'Disconnected';
                } else if (base === 'firmware-version' && firmwareVersion) {
                    elem.textContent = `Firmware: ${firmwareVersion}`;
                }
            });
        }

        // Helper function to update planner tab progress
        function updatePlannerProgress(data) {
            const plannerElements = {
                'current-target': data.current_target_name || '-',
                'current-phase': data.current_phase || '-',
                'targets-completed': `${data.targets_completed || 0} / ${data.total_targets || 0}`,
                'elapsed-time': data.elapsed_time || '-'
            };

            Object.entries(plannerElements).forEach(([id, value]) => {
                const elem = document.getElementById(id);
                if (elem) elem.textContent = value;
            });

            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                const progress = data.progress_percent || 0;
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${Math.round(progress)}%`;
            }
        }
    </script>

    <script>
        // Processing Tab JavaScript
        let procSelectedFilePath = null;
        let procSelectedFileName = null;
        let procCurrentJobId = null;
        let procJobPollInterval = null;
        let procCurrentBrowsePath = '';

        // File selection functions
        function procSelectFile(filePath, fileName) {
            procSelectedFilePath = filePath;
            procSelectedFileName = fileName;
            document.getElementById('proc-selectedFileName').textContent = fileName;
            document.getElementById('proc-selectedFilePath').textContent = filePath;
            document.getElementById('proc-selectedFileSection').style.display = 'block';
        }

        function procClearSelection() {
            procSelectedFilePath = null;
            procSelectedFileName = null;
            document.getElementById('proc-selectedFileSection').style.display = 'none';
        }

        // File processing function
        async function procProcessFile(processingType) {
            if (!procSelectedFilePath) {
                alert('Please select a file first');
                return;
            }

            try {
                const response = await fetch('/api/process/file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: procSelectedFilePath,
                        processing_type: processingType
                    })
                });

                if (!response.ok) throw new Error('Failed to start processing');

                const job = await response.json();
                procCurrentJobId = job.id;
                document.getElementById('proc-jobStatus').style.display = 'block';
                procStartJobPolling();

                // Refresh recent jobs list
                procLoadRecentJobs();
            } catch (error) {
                console.error('Error starting processing:', error);
                alert('Failed to start processing: ' + error.message);
            }
        }

        function procStartJobPolling() {
            if (procJobPollInterval) clearInterval(procJobPollInterval);
            procJobPollInterval = setInterval(async () => {
                if (!procCurrentJobId) return;
                try {
                    const response = await fetch(`/api/process/jobs/${procCurrentJobId}`);
                    if (!response.ok) throw new Error('Failed to get job status');
                    const job = await response.json();
                    const gpuBadge = job.gpu_used ? '<span class="gpu-badge">GPU ‚ö°</span>' : '';
                    document.getElementById('proc-jobStatus').innerHTML = `
                        <h3>Processing Job</h3>
                        <div><span class="job-status ${job.status}">${job.status.toUpperCase()}</span> ${gpuBadge}</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${job.progress_percent}%"></div></div>
                        <p>Progress: ${job.progress_percent.toFixed(1)}%</p>
                        ${job.current_step ? `<p>Current step: ${job.current_step}</p>` : ''}
                        ${job.status === 'complete' ? `<button onclick="window.location.href='/api/process/jobs/${job.id}/download'" class="btn btn-primary">üì• Download Result</button>` : ''}
                        ${job.error_message ? `<p style="color: #ff0000;">Error: ${job.error_message}</p>` : ''}`;
                    if (job.status === 'complete' || job.status === 'failed') {
                        clearInterval(procJobPollInterval);
                        procLoadRecentJobs();
                        procLoadOutputFiles();
                    }
                } catch (error) {
                    console.error('Error polling job status:', error);
                }
            }, 2000);
        }

        async function procLoadRecentJobs() {
            const jobsDiv = document.getElementById('proc-recentJobs');

            try {
                // Show loading state
                jobsDiv.innerHTML = '<p style="color: #888;">Loading recent jobs...</p>';

                console.log('Fetching recent jobs from /api/process/jobs...');
                const response = await fetch('/api/process/jobs?limit=10');

                if (!response.ok) {
                    throw new Error('Failed to load jobs');
                }

                const jobs = await response.json();
                console.log('Loaded jobs:', jobs.length, jobs);

                if (jobs.length === 0) {
                    jobsDiv.innerHTML = '<p style="color: #888;">No recent jobs. Process a file to get started!</p>';
                    return;
                }

                jobsDiv.innerHTML = jobs.map(job => {
                    const statusColor = job.status === 'complete' ? '#00ff00' :
                                       job.status === 'failed' ? '#ff0000' :
                                       job.status === 'running' ? '#00ffff' : '#ffff00';

                    // Extract preview image if available
                    let previewHtml = '';
                    if (job.status === 'complete' && job.output_files && job.output_files.length > 0) {
                        // Find first JPEG/PNG file for preview
                        const previewFile = job.output_files.find(path => {
                            const lower = path.toLowerCase();
                            return lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.png');
                        });

                        if (previewFile) {
                            const filename = previewFile.split('/').pop();
                            previewHtml = `
                                <div style="margin-bottom: 10px;">
                                    <img src="/api/process/outputs/${filename}"
                                         alt="Job ${job.id} output"
                                         style="width: 100%; max-width: 200px; height: auto; border-radius: 6px; border: 2px solid ${statusColor}; display: block;"
                                         onerror="this.style.display='none'">
                                </div>
                            `;
                        }
                    }

                    const downloadButton = job.status === 'complete' && job.output_files && job.output_files.length > 0 ?
                        `<button onclick="window.location.href='/api/process/jobs/${job.id}/download'" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">üì• Download</button>` : '';

                    const compareButton = job.status === 'complete' && job.output_files && job.output_files.length > 0 ?
                        `<button onclick="procShowComparison(${job.id})" class="btn btn-secondary" style="padding: 5px 15px; font-size: 0.9em; margin-top: 5px;">üî¨ Compare</button>` : '';

                    return `
                        <div class="file-item" style="border: 1px solid ${statusColor}; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: rgba(0,20,40,0.5);">
                            ${previewHtml}
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="color: ${statusColor}; font-weight: bold; margin-bottom: 5px;">
                                        ${job.status.toUpperCase()} ${job.gpu_used ? '‚ö° GPU' : ''}
                                    </div>
                                    <div style="color: #ccc; font-size: 0.9em;">
                                        Job #${job.id} | ${job.progress_percent.toFixed(1)}% complete
                                    </div>
                                    ${job.current_step ? `<div style="color: #888; font-size: 0.85em; margin-top: 3px;">${job.current_step}</div>` : ''}
                                    ${job.error_message ? `<div style="color: #ff0000; font-size: 0.85em; margin-top: 3px;">Error: ${job.error_message}</div>` : ''}
                                    <div style="color: #666; font-size: 0.8em; margin-top: 5px;">
                                        Started: ${job.started_at ? new Date(job.started_at).toLocaleString() : 'Not started'}
                                        ${job.completed_at ? ` | Completed: ${new Date(job.completed_at).toLocaleString()}` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 5px;">
                                    ${downloadButton}
                                    ${compareButton}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                console.log('Jobs rendered successfully');

            } catch (error) {
                console.error('Error loading recent jobs:', error);
                jobsDiv.innerHTML = `
                    <p style="color: #ff0000;">Error loading jobs: ${error.message}</p>
                `;
            }
        }

        // Scan for new captures
        async function procScanNewObjects() {
            try {
                const response = await fetch('/api/process/scan-new');
                if (!response.ok) return;

                const data = await response.json();
                const btn = document.getElementById('proc-newObjectsBtn');
                const count = document.getElementById('proc-newObjectsCount');

                if (data.total_objects > 0) {
                    count.textContent = data.total_objects;
                    btn.style.display = 'inline-block';
                    btn.dataset.objects = JSON.stringify(data.unprocessed_objects);
                } else {
                    btn.style.display = 'none';
                }
            } catch (error) {
                console.error('Error scanning for new objects:', error);
            }
        }

        // Process new objects
        async function procProcessNewObjects() {
            const btn = document.getElementById('proc-newObjectsBtn');
            const objects = JSON.parse(btn.dataset.objects || '[]');

            if (objects.length === 0) return;

            const totalFiles = objects.reduce((sum, obj) => sum + obj.unprocessed_count, 0);
            const objectList = objects.map(obj =>
                `  ‚Ä¢ ${obj.object_name}: ${obj.unprocessed_count} file(s)`
            ).join('\n');

            if (!confirm(`Process all new captures?\n\n${objects.length} objects with ${totalFiles} total files:\n\n${objectList}\n\nThis will use the improved quick_dso pipeline to match Seestar output.`)) {
                return;
            }

            // Disable button and show processing state
            btn.disabled = true;
            btn.textContent = '‚è≥ Processing...';

            try {
                const response = await fetch('/api/process/batch-process-new', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) {
                    throw new Error(`Failed to start batch processing: ${response.statusText}`);
                }

                const result = await response.json();

                alert(`‚úÖ Success!\n\nQueued ${result.total_files_queued} files for processing.\n\nJobs will appear in the Recent Jobs list as they complete.\n\nThe view will auto-refresh every 5 seconds.`);

                // Refresh the UI immediately
                if (typeof procLoadRecentJobs === 'function') procLoadRecentJobs();
                if (typeof procScanNewObjects === 'function') procScanNewObjects();
                if (typeof procLoadOutputFiles === 'function') procLoadOutputFiles();

                // Start auto-refresh every 5 seconds for 2 minutes to show progress
                let refreshCount = 0;
                const refreshInterval = setInterval(() => {
                    if (typeof procLoadRecentJobs === 'function') procLoadRecentJobs();
                    if (typeof procLoadOutputFiles === 'function') procLoadOutputFiles();

                    refreshCount++;
                    if (refreshCount >= 24) { // Stop after 2 minutes (24 * 5 seconds)
                        clearInterval(refreshInterval);
                        if (typeof procScanNewObjects === 'function') procScanNewObjects();
                    }
                }, 5000);

            } catch (error) {
                console.error('Batch processing error:', error);
                alert(`Error starting batch processing: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'üì∏ Process Objects';
            }
        }

        // Load output files
        async function procLoadOutputFiles() {
            const outputDiv = document.getElementById('proc-outputFiles');

            try {
                const response = await fetch('/api/process/outputs');
                if (!response.ok) {
                    outputDiv.innerHTML = '<p style="color: #888; text-align: center; padding: 40px 20px;">Error loading output files</p>';
                    return;
                }

                const data = await response.json();

                if (data.files.length === 0) {
                    outputDiv.innerHTML = '<p style="color: #888; text-align: center; padding: 40px 20px;">No output files yet</p>';
                    return;
                }

                outputDiv.innerHTML = data.files.map(file => {
                    const sizeKB = (file.size / 1024).toFixed(1);
                    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                    const sizeStr = file.size > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;

                    const previewHtml = file.is_previewable ? `
                        <div style="margin-bottom: 10px;">
                            <img src="${file.preview_url}"
                                 alt="${file.name}"
                                 style="width: 100%; max-width: 300px; height: auto; border-radius: 6px; border: 2px solid var(--tron-border); display: block;"
                                 onerror="this.style.display='none'">
                        </div>
                    ` : '';

                    return `
                        <div class="file-item" style="border: 1px solid #00ffff; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: rgba(0,20,40,0.5);">
                            ${previewHtml}
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #00ffff;">üìÑ ${file.name}</strong>
                            </div>
                            <div style="color: #888; font-size: 0.85em; margin-bottom: 8px;">
                                Size: ${sizeStr} | Modified: ${new Date(file.modified).toLocaleString()}
                            </div>
                            <button onclick="window.open('${file.download_url}', '_blank')" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">
                                üì• Download
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading output files:', error);
                outputDiv.innerHTML = '<p style="color: #ff0000; text-align: center; padding: 40px 20px;">Error loading output files</p>';
            }
        }

        // File browser function

        async function procBrowseFITS(path) {
            procCurrentBrowsePath = path;
            try {
                const response = await fetch(`/api/process/browse?path=${encodeURIComponent(path)}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        document.getElementById('proc-fileList').innerHTML = '<p style="color: #ff0000;">FITS directory not found. Set FITS_DIR in .env and restart.</p>';
                        return;
                    }
                    throw new Error('Failed to browse files');
                }
                const data = await response.json();
                document.getElementById('proc-currentPath').textContent = data.current_path ? `üìÇ ${data.current_path}` : 'üìÇ Root';
                let html = '';
                if (data.current_path) {
                    const parentPath = data.current_path.split('/').slice(0, -1).join('/');
                    html += `<div class="file-item" onclick="procBrowseFITS('${parentPath}')" style="cursor: pointer;"><strong>üìÅ ..</strong> (Parent directory)</div>`;
                }
                data.items.filter(item => item.is_dir).forEach(item => {
                    html += `<div class="file-item" onclick="procBrowseFITS('${item.path}')" style="cursor: pointer;">üìÅ <strong>${item.name}</strong></div>`;
                });
                data.items.filter(item => !item.is_dir && item.is_fits).forEach(item => {
                    html += `<div class="file-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìÑ ${item.name} <small style="color: #888;">(${(item.size / 1024 / 1024).toFixed(2)} MB)</small></span>
                        <button onclick="procSelectFile('${item.path}', '${item.name}')" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.9em;">Select</button>
                    </div>`;
                });
                data.items.filter(item => !item.is_dir && !item.is_fits).forEach(item => {
                    html += `<div class="file-item" style="opacity: 0.5;">üìÑ ${item.name} <small style="color: #888;">(not a FITS file)</small></div>`;
                });
                document.getElementById('proc-fileList').innerHTML = html || '<p style="color: #888;">Empty directory</p>';
            } catch (error) {
                document.getElementById('proc-fileList').innerHTML = `<p style="color: #ff0000;">Error: ${error.message}</p>`;
            }
        }

        // Comparison Modal Functions
        async function procShowComparison(jobId) {
            try {
                // Get comparison data
                const response = await fetch(`/api/process/jobs/${jobId}/seestar-comparison`);

                if (!response.ok) {
                    if (response.status === 404) {
                        alert('No Seestar preview found for this image. Seestar must have processed this object to enable comparison.');
                        return;
                    }
                    throw new Error('Failed to load comparison data');
                }

                const data = await response.json();

                // Set images
                document.getElementById('comparison-our-image').src = data.our_output;
                document.getElementById('comparison-seestar-image').src = data.seestar_preview;

                // Show modal
                document.getElementById('comparison-modal').style.display = 'block';

                // Load analysis
                const analysisResponse = await fetch('/api/process/analyze-comparison', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        our_image_url: data.our_output,
                        seestar_image_url: data.seestar_preview
                    })
                });

                if (!analysisResponse.ok) throw new Error('Failed to load analysis');

                const analysis = await analysisResponse.json();
                displayComparisonAnalysis(analysis);

            } catch (error) {
                console.error('Error showing comparison:', error);
                alert('Error loading comparison: ' + error.message);
            }
        }

        function displayComparisonAnalysis(analysis) {
            const content = document.getElementById('comparison-analysis-content');

            const differencesHtml = analysis.differences.map(diff => {
                const colorClass = diff.rating === 'Excellent' ? '#00ff00' :
                                  diff.rating === 'Good' ? '#00ffff' :
                                  diff.rating === 'Fair' ? '#ffff00' : '#ff8800';

                return `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(0,20,40,0.5); border-left: 3px solid ${colorClass}; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--tron-cyan); font-size: 1.1em;">${diff.aspect}</strong>
                            <span style="color: ${colorClass}; font-weight: bold;">${diff.rating}</span>
                        </div>
                        <p style="color: #ccc; line-height: 1.6;">${diff.observation}</p>
                    </div>
                `;
            }).join('');

            const recommendationsHtml = analysis.recommendations.map(rec =>
                `<li style="margin-bottom: 8px; color: #e0e0e0;">${rec}</li>`
            ).join('');

            content.innerHTML = `
                <div style="padding: 20px; background: rgba(0,100,100,0.1); border: 1px solid var(--tron-border); border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: var(--tron-cyan); margin-bottom: 10px;">Overall Assessment</h4>
                    <p style="color: #ccc; line-height: 1.8;">${analysis.overall_assessment}</p>
                </div>

                <h4 style="color: var(--tron-cyan); margin-bottom: 15px;">Detailed Analysis</h4>
                ${differencesHtml}

                <div style="margin-top: 30px; padding: 20px; background: rgba(0,20,40,0.6); border: 1px solid var(--tron-cyan); border-radius: 8px;">
                    <h4 style="color: var(--tron-cyan); margin-bottom: 10px;">üí° Recommendations</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${recommendationsHtml}
                    </ul>
                </div>
            `;
        }

        function closeComparisonModal() {
            document.getElementById('comparison-modal').style.display = 'none';
        }

        //  ============================================================================
        // Live View Tab JavaScript
        // ============================================================================

        let liveviewInterval = null;
        let liveviewRefreshMs = 30000; // Default to 30 seconds
        let liveviewAutoRefresh = true;
        let liveviewLastImagePath = null;

        async function liveviewLoadPreview() {
            try {
                const response = await fetch('/api/telescope/preview');
                if (!response.ok) {
                    throw new Error('Failed to fetch preview');
                }

                const data = await response.json();

                if (data.available) {
                    // Update status
                    document.getElementById('liveview-status-text').textContent = data.message;
                    document.getElementById('liveview-status-text').style.color = '#00ff00';

                    // Only update image if it's different
                    if (data.path !== liveviewLastImagePath) {
                        liveviewLastImagePath = data.path;

                        // Load the image
                        const img = document.getElementById('liveview-image');
                        img.src = `${data.download_url}?t=${Date.now()}`; // Cache buster
                        img.style.display = 'block';
                        document.getElementById('liveview-placeholder').style.display = 'none';

                        // Show image info
                        document.getElementById('liveview-filename').textContent = data.filename;
                        document.getElementById('liveview-filesize').textContent = formatFileSize(data.size_bytes);
                        document.getElementById('liveview-modified').textContent = new Date(data.modified_at).toLocaleString();
                        document.getElementById('liveview-info').style.display = 'block';
                    }

                    // Update last update time
                    document.getElementById('liveview-last-update').textContent =
                        `Last updated: ${new Date().toLocaleTimeString()}`;
                } else {
                    // No image available
                    document.getElementById('liveview-status-text').textContent = data.message;
                    document.getElementById('liveview-status-text').style.color = '#ffaa00';
                    document.getElementById('liveview-image').style.display = 'none';
                    document.getElementById('liveview-placeholder').style.display = 'block';
                    document.getElementById('liveview-info').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading telescope preview:', error);
                document.getElementById('liveview-status-text').textContent =
                    `Error: ${error.message}`;
                document.getElementById('liveview-status-text').style.color = '#ff0000';
            }
        }

        function liveviewRefreshNow() {
            liveviewLoadPreview();
        }

        function liveviewToggleAuto() {
            liveviewAutoRefresh = !liveviewAutoRefresh;

            if (liveviewAutoRefresh) {
                document.getElementById('liveview-auto-btn').innerHTML = '‚è∏Ô∏è Pause Auto-Refresh';
                document.getElementById('liveview-auto-btn').className = 'btn btn-primary';
                liveviewStartPolling();
                liveviewLoadPreview(); // Immediate refresh
            } else {
                document.getElementById('liveview-auto-btn').innerHTML = '‚ñ∂Ô∏è Resume Auto-Refresh';
                document.getElementById('liveview-auto-btn').className = 'btn btn-secondary';
                liveviewStopPolling();
            }
        }

        function liveviewChangeInterval() {
            const select = document.getElementById('liveview-interval');
            liveviewRefreshMs = parseInt(select.value);

            if (liveviewAutoRefresh) {
                liveviewStopPolling();
                liveviewStartPolling();
            }
        }

        function liveviewStartPolling() {
            if (liveviewInterval) {
                clearInterval(liveviewInterval);
            }
            liveviewInterval = setInterval(liveviewLoadPreview, liveviewRefreshMs);
        }

        function liveviewStopPolling() {
            if (liveviewInterval) {
                clearInterval(liveviewInterval);
                liveviewInterval = null;
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ========================================================================
        // Astronomy Dashboard Functions
        // ========================================================================

        async function loadAstronomyWeather() {
            const lat = document.getElementById('astro-latitude').value;
            const lon = document.getElementById('astro-longitude').value;
            const resultsDiv = document.getElementById('astro-weather-results');

            resultsDiv.innerHTML = '<p style="color: #888;">Loading weather forecast...</p>';

            try {
                const response = await fetch(`/api/weather/astronomy?lat=${lat}&lon=${lon}&hours=48`);
                if (!response.ok) throw new Error('Failed to load weather');

                const data = await response.json();

                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">';
                html += '<tr style="background: #f0f0f0; font-weight: bold;"><th style="padding: 8px; text-align: left;">Time</th><th>Cloud Cover</th><th>Transparency</th><th>Seeing</th><th>Score</th></tr>';

                data.forecast.forEach((entry, index) => {
                    const time = new Date(entry.time).toLocaleString();
                    const score = (entry.astronomy_score * 100).toFixed(0);
                    const scoreColor = score >= 70 ? '#00ff00' : score >= 40 ? '#ffaa00' : '#ff0000';
                    const bgColor = index % 2 === 0 ? '#fff' : '#f9f9f9';

                    html += `<tr style="background: ${bgColor};">`;
                    html += `<td style="padding: 8px;">${time}</td>`;
                    html += `<td style="text-align: center;">${entry.cloud_cover.description}</td>`;
                    html += `<td style="text-align: center;">${entry.transparency}</td>`;
                    html += `<td style="text-align: center;">${entry.seeing}</td>`;
                    html += `<td style="text-align: center; font-weight: bold; color: ${scoreColor};">${score}%</td>`;
                    html += '</tr>';
                });

                html += '</table></div>';
                html += '<p style="margin-top: 15px; color: #666; font-size: 0.85em;">Showing next 48 hours | Higher scores = better observing conditions</p>';

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading astronomy weather:', error);
                resultsDiv.innerHTML = '<p style="color: #ff0000;">Error loading weather: ' + error.message + '</p>';
            }
        }

        async function loadISSPasses() {
            const lat = document.getElementById('astro-latitude').value;
            const lon = document.getElementById('astro-longitude').value;
            const days = document.getElementById('iss-days').value;
            const resultsDiv = document.getElementById('iss-passes-results');

            resultsDiv.innerHTML = '<p style="color: #888;">Loading ISS passes...</p>';

            try {
                const response = await fetch(`/api/satellites/iss?lat=${lat}&lon=${lon}&days=${days}`);
                if (!response.ok) throw new Error('Failed to load ISS passes');

                const data = await response.json();

                if (data.passes.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #888;">No visible ISS passes found for the next ' + days + ' days.</p>';
                    return;
                }

                let html = '<div style="max-height: 400px; overflow-y: auto;">';

                data.passes.forEach(pass => {
                    const startTime = new Date(pass.start_time).toLocaleString();
                    const quality = (pass.quality_score * 100).toFixed(0);
                    const qualityColor = quality >= 70 ? '#00ff00' : quality >= 40 ? '#ffaa00' : '#ff0000';

                    html += '<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">';
                    html += `<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">`;
                    html += `<strong style="font-size: 1.1em;">${startTime}</strong>`;
                    html += `<span style="font-weight: bold; color: ${qualityColor};">Quality: ${quality}%</span>`;
                    html += '</div>';
                    html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">`;
                    html += `<div><strong>Max Altitude:</strong> ${pass.max_altitude_deg.toFixed(1)}¬∞</div>`;
                    html += `<div><strong>Duration:</strong> ${pass.duration_minutes.toFixed(1)} min</div>`;
                    html += `<div><strong>Visibility:</strong> ${pass.visibility}</div>`;
                    html += `<div><strong>Magnitude:</strong> ${pass.magnitude ? pass.magnitude.toFixed(1) : 'N/A'}</div>`;
                    html += '</div></div>';
                });

                html += '</div>';
                html += `<p style="margin-top: 15px; color: #666; font-size: 0.85em;">Found ${data.passes.length} visible passes in the next ${days} days</p>`;

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading ISS passes:', error);
                resultsDiv.innerHTML = '<p style="color: #ff0000;">Error loading ISS passes: ' + error.message + '</p>';
            }
        }

        async function loadViewingMonths() {
            const lat = document.getElementById('astro-latitude').value;
            const ra = document.getElementById('view-ra').value;
            const dec = document.getElementById('view-dec').value;
            const objectName = document.getElementById('view-object-name').value;
            const resultsDiv = document.getElementById('viewing-months-results');

            resultsDiv.innerHTML = '<p style="color: #888;">Calculating viewing months...</p>';

            try {
                let url = `/api/viewing-months?ra_hours=${ra}&dec_degrees=${dec}&latitude=${lat}`;
                if (objectName) url += `&object_name=${encodeURIComponent(objectName)}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to calculate viewing months');

                const data = await response.json();

                let html = '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">';

                data.months.forEach(month => {
                    const ratingColor =
                        month.rating === 'excellent' ? '#00ff00' :
                        month.rating === 'good' ? '#7fff00' :
                        month.rating === 'fair' ? '#ffaa00' :
                        month.rating === 'poor' ? '#ff6600' : '#ff0000';

                    html += '<div style="border: 2px solid ' + ratingColor + '; border-radius: 8px; padding: 10px; background: rgba(255,255,255,0.9);">';
                    html += `<div style="font-weight: bold; margin-bottom: 5px;">${month.month_name}</div>`;
                    html += `<div style="color: ${ratingColor}; text-transform: capitalize; font-weight: bold;">${month.rating}</div>`;
                    html += `<div style="font-size: 0.85em; margin-top: 5px; color: #666;">${month.visibility_hours.toFixed(1)}h visible</div>`;
                    html += `<div style="font-size: 0.8em; color: #888;">Best: ${month.best_time}</div>`;
                    html += '</div>';
                });

                html += '</div></div>';

                if (data.object_name) {
                    html += `<p style="margin-top: 15px; font-weight: bold;">Object: ${data.object_name}</p>`;
                }
                html += `<p style="color: #666; font-size: 0.85em;">RA: ${ra}h, Dec: ${dec}¬∞</p>`;

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error calculating viewing months:', error);
                resultsDiv.innerHTML = '<p style="color: #ff0000;">Error: ' + error.message + '</p>';
            }
        }

        async function loadSkyQuality() {
            const lat = document.getElementById('astro-latitude').value;
            const lon = document.getElementById('astro-longitude').value;
            const resultsDiv = document.getElementById('sky-quality-results');

            resultsDiv.innerHTML = '<p style="color: #888;">Checking sky quality...</p>';

            try {
                const response = await fetch(`/api/sky-quality/${lat}/${lon}`);
                if (!response.ok) throw new Error('Failed to load sky quality');

                const data = await response.json();

                const bortleColor =
                    data.bortle_class <= 2 ? '#00ff00' :
                    data.bortle_class <= 4 ? '#7fff00' :
                    data.bortle_class <= 6 ? '#ffaa00' : '#ff0000';

                let html = '<div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">';
                html += `<div style="font-size: 2em; font-weight: bold; color: ${bortleColor}; margin-bottom: 10px;">`;
                html += `Bortle ${data.bortle_class}</div>`;
                html += `<div style="font-size: 1.2em; margin-bottom: 15px;">${data.bortle_name}</div>`;
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">';
                html += `<div><strong>SQM:</strong> ${data.sqm_estimate ? data.sqm_estimate.toFixed(2) : 'N/A'}</div>`;
                html += `<div><strong>Limiting Magnitude:</strong> ${data.limiting_magnitude ? data.limiting_magnitude.toFixed(1) : 'N/A'}</div>`;
                html += `<div><strong>Light Pollution:</strong> ${data.light_pollution_level}</div>`;
                html += `<div><strong>Milky Way:</strong> ${data.milky_way_visibility}</div>`;
                html += '</div>';
                html += `<div style="padding: 10px; background: white; border-radius: 6px; margin-bottom: 10px;">`;
                html += `<strong>Visibility:</strong> ${data.visibility_description}</div>`;

                if (data.suitable_for && data.suitable_for.length > 0) {
                    html += '<div style="padding: 10px; background: white; border-radius: 6px;">';
                    html += '<strong>Suitable for:</strong> ' + data.suitable_for.join(', ') + '</div>';
                }

                html += '</div>';
                html += `<p style="margin-top: 10px; color: #666; font-size: 0.8em;">Source: ${data.light_pollution_source}</p>`;

                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error loading sky quality:', error);
                resultsDiv.innerHTML = '<p style="color: #ff0000;">Error: ' + error.message + '</p>';
            }
        }

        // ========================================
        // Settings Tab Functions
        // ========================================

        let settingsDevices = [];
        let settingsLocations = [];
        let settingsAppSettings = [];

        function showSettingsSubtab(subtabName) {
            // Hide all subtabs
            document.querySelectorAll('.settings-subtab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            // Remove active class from all subtab buttons
            document.querySelectorAll('.settings-subtab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected subtab
            const targetTab = document.getElementById(subtabName + '-subtab');
            const targetBtn = document.getElementById(subtabName + '-subtab-btn');

            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
            if (targetBtn) targetBtn.classList.add('active');
        }

        async function loadSettingsData() {
            await Promise.all([loadDevices(), loadLocations(), loadAppSettings()]);
        }

        // ======== Devices ========
        async function loadDevices() {
            try {
                const response = await fetch('/api/settings/devices?active_only=false');
                settingsDevices = await response.json();
                renderDevices();
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        function renderDevices() {
            const container = document.getElementById('devices-list');
            if (!container) return;
            if (settingsDevices.length === 0) {
                container.innerHTML = '<p style="color: #ccc;">No devices configured. Click "Add Device" to create one.</p>';
                return;
            }

            container.innerHTML = settingsDevices.map(device => `
                <div class="settings-card">
                    <h4>${device.name} ${device.is_default ? '<span class="badge badge-success">Default</span>' : ''}</h4>
                    <div class="card-details">
                        ${device.description ? `<p>${device.description}</p>` : ''}
                        <p><strong>Control:</strong> ${device.is_control_enabled ? `${device.control_host}:${device.control_port}` : 'Disabled'}</p>
                        <p><strong>Mount:</strong> ${device.is_mount_enabled ? device.mount_path : 'Disabled'}</p>
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="editDevice(${device.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteDevice(${device.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showDeviceModal(deviceId = null) {
            const modal = document.getElementById('device-modal');
            const title = document.getElementById('device-modal-title');
            const form = document.getElementById('device-form');

            if (deviceId) {
                const device = settingsDevices.find(d => d.id === deviceId);
                title.textContent = 'Edit Seestar Device';
                document.getElementById('device-id').value = device.id;
                document.getElementById('device-name').value = device.name;
                document.getElementById('device-description').value = device.description || '';
                document.getElementById('device-control-host').value = device.control_host || '';
                document.getElementById('device-control-port').value = device.control_port;
                document.getElementById('device-control-enabled').checked = device.is_control_enabled;
                document.getElementById('device-mount-path').value = device.mount_path || '';
                document.getElementById('device-mount-enabled').checked = device.is_mount_enabled;
                document.getElementById('device-is-default').checked = device.is_default;
            } else {
                title.textContent = 'Add Seestar Device';
                form.reset();
                document.getElementById('device-id').value = '';
                document.getElementById('device-control-port').value = '4700';
            }

            modal.style.display = 'flex';
        }

        function closeDeviceModal() {
            document.getElementById('device-modal').style.display = 'none';
        }

        function editDevice(deviceId) {
            showDeviceModal(deviceId);
        }

        async function saveDevice(event) {
            event.preventDefault();

            const deviceId = document.getElementById('device-id').value;
            const deviceData = {
                name: document.getElementById('device-name').value,
                description: document.getElementById('device-description').value || null,
                control_host: document.getElementById('device-control-host').value || null,
                control_port: parseInt(document.getElementById('device-control-port').value),
                is_control_enabled: document.getElementById('device-control-enabled').checked,
                mount_path: document.getElementById('device-mount-path').value || null,
                is_mount_enabled: document.getElementById('device-mount-enabled').checked,
                is_default: document.getElementById('device-is-default').checked
            };

            try {
                const url = deviceId ? `/api/settings/devices/${deviceId}` : '/api/settings/devices';
                const method = deviceId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(deviceData)
                });

                if (response.ok) {
                    closeDeviceModal();
                    loadDevices();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to save device'));
                }
            } catch (error) {
                alert('Error saving device: ' + error.message);
            }
        }

        async function deleteDevice(deviceId) {
            if (!confirm('Are you sure you want to delete this device?')) return;

            try {
                const response = await fetch(`/api/settings/devices/${deviceId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadDevices();
                } else {
                    alert('Failed to delete device');
                }
            } catch (error) {
                alert('Error deleting device: ' + error.message);
            }
        }

        // ======== Locations ========
        async function loadLocations() {
            try {
                const response = await fetch('/api/settings/locations?active_only=false');
                settingsLocations = await response.json();
                renderLocations();
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        function renderLocations() {
            const container = document.getElementById('locations-list');
            if (!container) return;
            if (settingsLocations.length === 0) {
                container.innerHTML = '<p style="color: #ccc;">No locations configured. Click "Add Location" to create one.</p>';
                return;
            }

            container.innerHTML = settingsLocations.map(location => `
                <div class="settings-card">
                    <h4>${location.name} ${location.is_default ? '<span class="badge badge-success">Default</span>' : ''}</h4>
                    <div class="card-details">
                        ${location.description ? `<p>${location.description}</p>` : ''}
                        <p><strong>Coordinates:</strong> ${location.latitude.toFixed(4)}, ${location.longitude.toFixed(4)}</p>
                        <p><strong>Elevation:</strong> ${location.elevation}m | <strong>Timezone:</strong> ${location.timezone}</p>
                        ${location.bortle_class ? `<p><strong>Bortle Class:</strong> ${location.bortle_class}</p>` : ''}
                    </div>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="editLocation(${location.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteLocation(${location.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function showLocationModal(locationId = null) {
            const modal = document.getElementById('location-modal');
            const title = document.getElementById('location-modal-title');
            const form = document.getElementById('location-form');

            if (locationId) {
                const location = settingsLocations.find(l => l.id === locationId);
                title.textContent = 'Edit Observing Location';
                document.getElementById('location-id').value = location.id;
                document.getElementById('location-name-input').value = location.name;
                document.getElementById('location-description').value = location.description || '';
                document.getElementById('location-latitude').value = location.latitude;
                document.getElementById('location-longitude').value = location.longitude;
                document.getElementById('location-elevation').value = location.elevation;
                document.getElementById('location-timezone').value = location.timezone;
                document.getElementById('location-bortle').value = location.bortle_class || '';
                document.getElementById('location-is-default').checked = location.is_default;
            } else {
                title.textContent = 'Add Observing Location';
                form.reset();
                document.getElementById('location-id').value = '';
            }

            modal.style.display = 'flex';
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
        }

        function editLocation(locationId) {
            showLocationModal(locationId);
        }

        async function saveLocation(event) {
            event.preventDefault();

            const locationId = document.getElementById('location-id').value;
            const locationData = {
                name: document.getElementById('location-name-input').value,
                description: document.getElementById('location-description').value || null,
                latitude: parseFloat(document.getElementById('location-latitude').value),
                longitude: parseFloat(document.getElementById('location-longitude').value),
                elevation: parseFloat(document.getElementById('location-elevation').value) || 0,
                timezone: document.getElementById('location-timezone').value || 'UTC',
                bortle_class: document.getElementById('location-bortle').value ? parseInt(document.getElementById('location-bortle').value) : null,
                is_default: document.getElementById('location-is-default').checked
            };

            try {
                const url = locationId ? `/api/settings/locations/${locationId}` : '/api/settings/locations';
                const method = locationId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(locationData)
                });

                if (response.ok) {
                    closeLocationModal();
                    loadLocations();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.detail || 'Failed to save location'));
                }
            } catch (error) {
                alert('Error saving location: ' + error.message);
            }
        }

        async function deleteLocation(locationId) {
            if (!confirm('Are you sure you want to delete this location?')) return;

            try {
                const response = await fetch(`/api/settings/locations/${locationId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadLocations();
                } else {
                    alert('Failed to delete location');
                }
            } catch (error) {
                alert('Error deleting location: ' + error.message);
            }
        }

        // ======== App Settings ========
        async function loadAppSettings() {
            try {
                // First try to initialize default settings
                await fetch('/api/settings/app/init', { method: 'POST' });

                const response = await fetch('/api/settings/app');
                settingsAppSettings = await response.json();
                renderAppSettings();
            } catch (error) {
                console.error('Error loading app settings:', error);
            }
        }

        function renderAppSettings() {
            const categories = {
                'telescope': document.getElementById('telescope-settings-list'),
                'processing': document.getElementById('processing-settings-list'),
                'storage': document.getElementById('storage-settings-list'),
                'ui': document.getElementById('ui-settings-list'),
                'planning': document.getElementById('planning-settings-list')
            };

            // Clear all containers
            Object.values(categories).forEach(container => {
                if (container) container.innerHTML = '';
            });

            settingsAppSettings.forEach(setting => {
                const container = categories[setting.category];
                if (!container) return;

                const inputType = setting.value_type === 'bool' ? 'checkbox' :
                                  setting.value_type === 'int' ? 'number' : 'text';

                const inputHtml = setting.value_type === 'bool'
                    ? `<input type="checkbox" id="setting-${setting.key}" ${setting.value === 'true' ? 'checked' : ''} data-key="${setting.key}">`
                    : `<input type="${inputType}" id="setting-${setting.key}" value="${setting.value}" data-key="${setting.key}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">`;

                container.innerHTML += `
                    <div class="settings-input-row">
                        <label for="setting-${setting.key}">${setting.key.split('.')[1].replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                        ${inputHtml}
                        <span class="setting-description">${setting.description || ''}</span>
                    </div>
                `;
            });
        }

        async function saveAllAppSettings() {
            const updates = [];

            settingsAppSettings.forEach(setting => {
                const input = document.getElementById(`setting-${setting.key}`);
                if (!input) return;

                let newValue;
                if (setting.value_type === 'bool') {
                    newValue = input.checked ? 'true' : 'false';
                } else {
                    newValue = input.value;
                }

                if (newValue !== setting.value) {
                    updates.push({ key: setting.key, value: newValue });
                }
            });

            try {
                for (const update of updates) {
                    await fetch(`/api/settings/app/${update.key}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: update.value })
                    });
                }
                alert('Settings saved successfully!');
                loadAppSettings();
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }
    </script>
</body>
</html>
